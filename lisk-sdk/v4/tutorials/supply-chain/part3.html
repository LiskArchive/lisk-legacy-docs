<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Part 3: A simple supply chain management system :: Lisk documentation</title>
    <link rel="canonical" href="https://lisk.com/documentation/lisk-sdk/v4/tutorials/supply-chain/part3.html">
    <link rel="prev" href="part2.html">
    <link rel="next" href="part4.html">
    <meta name="description" content="Part 3 of the Lisk supply chain tutorial describes how to implement, start &amp; finish transactions including locking funds in an account.">
    <meta name="generator" content="Antora 3.1.1">

  <link id="theme" rel="stylesheet" title="Default" href="../../../../_/css/site.css">
  <link rel="stylesheet" title="Dark" href="../../../../_/css/dark-site.css">

    <script>var uiRootPath = '../../../../_'</script>
    <script src="../../../../_/js/vendor/medium-zoom.js"></script>
    <script type="text/javascript" id="Cookiebot" src="https://consent.cookiebot.com/uc.js" data-cbid="e4db29b5-cd94-4bcf-87e4-04f4ca564240" data-blockingmode="manual"></script>
    <!-- Matomo -->
    <script>
      var _paq = window._paq = window._paq || [];
      /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
      _paq.push(['trackPageView']);
      _paq.push(['enableLinkTracking']);
      (function() {
        var u="https://lisk.matomo.cloud/";
        _paq.push(['setTrackerUrl', u+'matomo.php']);
        _paq.push(['setSiteId', '2']);
        var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
        g.async=true; g.src='//cdn.matomo.cloud/lisk.matomo.cloud/matomo.js'; s.parentNode.insertBefore(g,s);
      })();
    </script>
    <!-- End Matomo Code -->
    <!-- Matomo Tag Manager -->
    <script>
      var _mtm = window._mtm = window._mtm || [];
      _mtm.push({'mtm.startTime': (new Date().getTime()), 'event': 'mtm.Start'});
      var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
      g.async=true; g.src='https://cdn.matomo.cloud/lisk.matomo.cloud/container_RUW6y8yf.js'; s.parentNode.insertBefore(g,s);
    </script>
    <!-- End Matomo Tag Manager -->
<link rel="icon" href="../../../../_/img/favicon.png" type="image/x-icon">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <div class="top-logo">
        <a href="../../../.." class="lisk-logo"></a>
        <a href="../../../.." class="docs-logo"></a>
      </div>
      <!--<a class="navbar-item" href="https://lisk.com/documentation">Lisk documentation</a>-->
        <div id="docsearch" class="navbar-menu search-box hide-for-print">
          <!--<input id="search-input-toolbar" type="text" placeholder="Search me ...">-->
        </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">APIs</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="../../../../api/lisk-node-http.html">Lisk node HTTP API</a>
            <a class="navbar-item" href="../../../../api/lisk-node-rpc.html">Lisk node RPC API</a>
            <a class="navbar-item" href="../../../../api/lisk-service-http.html">Lisk Service HTTP API</a>
            <a class="navbar-item" href="../../../../api/lisk-service-rpc.html">Lisk Service RPC API</a>
            <a class="navbar-item" href="../../../../api/lisk-service-pubsub.html">Lisk Service Pub/Sub API</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Explorers</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://lisk.observer/" target="_blank">Lisk Observer</a>
            <a class="navbar-item" href="https://liskscan.com/" target="_blank">LiskScan</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Products</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="../../../../lisk-sdk/">Lisk SDK</a>
            <a class="navbar-item" href="../../../../lisk-service/">Lisk Service</a>
            <a class="navbar-item" href="../../../../lisk-core/">Lisk Core</a>
            <a class="navbar-item" href="https://lisk.com/wallet" target="_blank">Lisk Wallets</a>
          </div>
        </div>
        <button onclick="switch_style('toggle')" id="theme-toggle" class="theme-toggle navbar-item"></button>
        <!-- <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div> -->
      </div>
    </div>
  </nav>
</header>
<div class="toolbar" role="navigation">
  <button class="nav-toggle"></button>
  <div class="components-versions">
      <div class="page-components">
    <button class="component-menu-toggle" title="Show other documentations">Lisk SDK</button>
    <div class="component-menu">
        <a class="component" href="../../../../lisk-core/index.html">Lisk Core</a>
        <a class="component" href="../../../../index.html">Lisk Documentation</a>
        <a class="component is-current" href="../../../index.html">Lisk SDK</a>
        <a class="component" href="../../../../lisk-service/v0.7/index.html">Lisk Service</a>
    </div>
  </div>
    <span></span>
    <div class="page-versions">
  <button class="version-menu-toggle" title="Show other versions of page">4.0.0</button>
  <div class="version-menu">
    <a class="version is-missing" href="../../../index.html">5.2.2 (latest)</a>
    <a class="version is-current" href="part3.html">4.0.0</a>
    <a class="version" href="../../../v3/tutorials/supply-chain/part3.html">3.0.2</a>
  </div>
</div>
  </div>
  <span></span>
  <span></span>
  <a href="../../../../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../../index.html">Lisk SDK</a></li>
    <li><a href="../index.html">Tutorials</a></li>
    <li><a href="index.html">Supply Chain</a></li>
    <li><a href="part3.html">Part 3: A simple supply chain management system</a></li>
  </ul>
</nav>
    <div id="docsearch-toolbar" class="search-box hide-for-print toolbar-search">
      <!--<input id="search-input" type="text" placeholder="Search me ...">-->
    </div>
  <div class="edit-this-page"><a href="https://github.com/LiskHQ/lisk-docs/edit/docs-sdk-4.0.0/modules/ROOT/pages/tutorials/supply-chain/part3.adoc"><img class="pencil">Edit this Page</a></div>
  </div>
<div class="body">
<div class="nav-container" data-component="lisk-sdk" data-version="v4">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../../index.html">Lisk SDK</a></h3>
<ul class="nav-list">
  <li class="nav-item parent" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../setup.html">Prerequisites</a>
  </li>
  <li class="nav-item parent" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Explanations</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../explanations/consensus.html">Consensus in Lisk</a>
  </li>
</ul>
  </li>
  <li class="nav-item parent" data-depth="1">
    <button class="nav-item-toggle"></button>
        <span>
    <a class="nav-link" href="../../guides/index.html">Guides</a>
        </span>
<ul class="nav-list">
  <li class="nav-item parent" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Application development</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../guides/app-development/configuration.html">Configure a blockchain application</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../guides/app-development/custom-transactions.html">Create a custom transaction</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../guides/app-development/test-transaction.html">Test a transaction</a>
  </li>
  <li class="nav-item parent" data-depth="3">
    <button class="nav-item-toggle"></button>
        <span>
    <a class="nav-link" href="../../guides/app-development/interact-with-api.html">Interact with the API</a>
        </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../../guides/app-development/broadcast.html">Broadcast a transaction</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../guides/app-development/frontend.html">Connect a frontend</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../guides/app-development/launch.html">Launch a blockchain application</a>
  </li>
</ul>
  </li>
  <li class="nav-item parent" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Node management</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../guides/node-management/managing-accounts.html">Managing accounts</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../guides/node-management/forging.html">Enable forging</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../guides/node-management/api-access.html">API access</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../guides/node-management/enable-ssl.html">Enable SSL</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../guides/node-management/logging.html">Logging</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item parent" data-depth="1">
    <button class="nav-item-toggle"></button>
        <span>
    <a class="nav-link" href="../index.html">Tutorials</a>
        </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../hello-world.html">Hello World</a>
  </li>
  <li class="nav-item parent" data-depth="2">
    <button class="nav-item-toggle"></button>
        <span>
    <a class="nav-link" href="index.html">Supply Chain</a>
        </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="part1.html">Part 1: Installation &amp; setup</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="part2.html">Part 2: Track a packet on the blockchain</a>
  </li>
  <li class="nav-item is-current-page" data-depth="3">
    <a class="nav-link" href="part3.html">Part 3: A simple supply chain management system</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="part4.html">Part 4: How to publish the application</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item parent" data-depth="1">
    <button class="nav-item-toggle"></button>
        <span>
    <a class="nav-link" href="../../references/index.html">References</a>
        </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../references/api-specification.html">API specification</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../references/config.html">Configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../references/changelog.html">ChangeLog 3.x to 4.x</a>
  </li>
  <li class="nav-item parent" data-depth="2">
    <button class="nav-item-toggle"></button>
        <span>
    <a class="nav-link" href="../../references/lisk-commander/index.html">Lisk Commander</a>
        </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../references/lisk-commander/commands.html">Commands</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../references/lisk-commander/lisk-core-commands.html">Lisk Core commands</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../references/lisk-commander/sensitive-inputs.html">Sensitive inputs</a>
  </li>
</ul>
  </li>
  <li class="nav-item parent" data-depth="2">
    <button class="nav-item-toggle"></button>
        <span>
    <a class="nav-link" href="../../references/lisk-elements/index.html">Lisk Elements</a>
        </span>
<ul class="nav-list">
  <li class="nav-item parent" data-depth="3">
    <button class="nav-item-toggle"></button>
        <span>
    <a class="nav-link" href="../../references/lisk-elements/api-client.html">API client</a>
        </span>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../../references/lisk-elements/api-client/accounts.html">Accounts</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../../references/lisk-elements/api-client/blocks.html">Blocks</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../../references/lisk-elements/api-client/dapps.html">DApps</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../../references/lisk-elements/api-client/delegates.html">Delegates</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../../references/lisk-elements/api-client/node.html">Node</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../../references/lisk-elements/api-client/peers.html">Peers</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../../references/lisk-elements/api-client/transactions.html">Transactions</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../../references/lisk-elements/api-client/voters.html">Voters</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../../references/lisk-elements/api-client/votes.html">Votes</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../references/lisk-elements/bft.html">BFT</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../references/lisk-elements/chain.html">Chain</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../references/lisk-elements/client.html">Client</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../references/lisk-elements/constants.html">Constants</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../references/lisk-elements/cryptography.html">Cryptography</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../references/lisk-elements/dpos.html">DPoS</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../references/lisk-elements/p2p.html">P2P</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../references/lisk-elements/passphrase.html">Passphrase</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../references/lisk-elements/transaction-pool.html">Transaction pool</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../references/lisk-elements/transactions.html">Transactions</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../references/lisk-elements/validator.html">Validator</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../references/lisk-framework/index.html">Lisk Framework</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Lisk SDK</span>
    <span class="version">4.0.0</span>
  </div>
  <ul class="components">
    <li class="component">
      <a class="title" href="../../../../lisk-core/index.html">Lisk Core</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../lisk-core/index.html">3.0.4 (latest)</a>
        </li>
        <li class="version">
          <a href="../../../../lisk-core/v2/index.html">2.1.7</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../../index.html">Lisk Documentation</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../index.html">default</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <a class="title" href="../../../index.html">Lisk SDK</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../index.html">5.2.2 (latest)</a>
        </li>
        <li class="version is-current">
          <a href="../../index.html">4.0.0</a>
        </li>
        <li class="version">
          <a href="../../../v3/index.html">3.0.2</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../../lisk-service/v0.7/index.html">Lisk Service</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../lisk-service/v0.7/index.html">0.7.0 (beta)</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Part 3: A simple supply chain management system</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>The goal of Part 3 covers how to implement a complete workflow of a simple version of a supply chain tracking system.</p>
</div>
<div class="paragraph">
<p>The following points below are covered in this section:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>How to implement the missing transactions types <code>RegisterPacket</code>, <code>StartTransport</code> and <code>FinishTransport</code>.</p>
</li>
<li>
<p>How to cache multiple accounts in the <code>prepare</code> step.</p>
</li>
<li>
<p>How to implement a simple trust system.</p>
</li>
<li>
<p>How to lock funds in an account.</p>
</li>
<li>
<p>How to execute a first complete test run of the supply chain tracking system.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It is recommended to view the <a href="index.html#procedure" class="xref page">diagram on the Introduction page</a>, which will help the user to have an overiew of the workshop.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">"Are there more of those&#8230;&#8203; solutions?"</dt>
<dd>
<p><a href="https://github.com/LiskHQ/lisk-sdk-examples/tree/v4/transport/transactions/solutions" target="_blank" rel="noopener">Yes, there are more!</a>, check out the fully working implementation of the other transactions in the <code>transactions/solutions/</code> folder.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>After completing a task, compare with the solutions in order to verify if the task has been successfully completed.
However, be aware that there is not only just one valid solution to write the code.
In step 3.3 later in this section, the actual code will be run to verify it functions correctly.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#register_packet">3.0 Implement RegisterPacket</a>
<ul class="sectlevel2">
<li><a href="#task-complete-the-implementation-of-the-undoasset-function">Task: Complete the implementation of the <code>undoAsset</code> function.</a></li>
<li><a href="#explanation-undoassetstore">Explanation: <code>undoAsset(store)</code></a></li>
</ul>
</li>
<li><a href="#3-1-start-the-transport">3.1 Start the transport</a>
<ul class="sectlevel2">
<li><a href="#task-lock-funds">Task: Lock funds</a></li>
<li><a href="#explanation-prepare">Explanation: <code>prepare()</code></a></li>
</ul>
</li>
<li><a href="#3-2-finish-the-transport">3.2 Finish the transport</a>
<ul class="sectlevel2">
<li><a href="#explanation-caching-data-based-on-data-from-the-db">Explanation: Caching data based on data from the db</a></li>
<li><a href="#task-implement-the-logic-in-applyasset-for-a-successful-transport">Task: Implement the logic in <code>applyAsset()</code> for a successful transport</a></li>
</ul>
</li>
<li><a href="#3-3-test-out-the-full-workflow-with-the-client-app">3.3 Test out the full workflow with the client app</a>
<ul class="sectlevel2">
<li><a href="#check_status">Check the status in the <code>lightAlarmTransaction</code></a></li>
<li><a href="#register-all-transaction-types-with-the-node-app">Register all transaction types with the node app</a></li>
<li><a href="#try-it-out-in-the-client-app">Try it out in the client app</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="sect1">
<h2 id="register_packet"><a class="anchor" href="#register_packet"></a>3.0 Implement RegisterPacket</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To move on to the next step in the prototype it is necessary to implement the <code>RegisterPacket</code> transaction.
This transaction will register a packet on the blockchain that is ready to be picked up by a delivery person.
The transaction allows the package owner to define the following properties:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>packetId</code>: The ID of the packet account (registered on Raspberry Pi).</p>
</li>
<li>
<p><code>postage</code>: The postage refers to a number of LSK tokens the carrier receives upon successful delivery of the packet.
The postage is stored in the packet account&#8217;s asset field.</p>
</li>
<li>
<p><code>security</code>: The security refers to a number of LSK tokens that the carrier should lock as a "security" before the packet can be accepted for delivery.
Upon successful delivery, the security regarding the carriers balance will be unlocked again.</p>
</li>
<li>
<p><code>minTrust</code>: This minimum trust property has been introduced to keep track of well behaving/performing carriers.
Whenever a carrier successfully delivers a packet, their trust will be increased by a factor of one.
The package owner can set a minimal trust level for a carrier before he/she can accept the package for delivery.
If a carrier has a lower trust than the minimal required trust level, it is not possible to accept the package for delivery.</p>
</li>
<li>
<p><code>recipientId</code>: Please note that this is a highly important field, as it sets the actual recipient who will receive the package.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For the <code>RegisterPacketTransaction</code> the following guide runs through the <code>undoAsset()</code> function and explains how this can be achieved. This in turn allows the user to implement the following small snippet of code shown below:</p>
</div>
<div class="listingblock">
<div class="title">Contents of <code>register-packet.js</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-js hljs" data-lang="js">const {
    BaseTransaction,
    TransactionError
} = require('@liskhq/lisk-transactions');

/**
 * Register new package for sender and update package account.
 */
class RegisterPacketTransaction extends BaseTransaction {

    static get TYPE () {
        return 20;
    }

    async prepare(store) {
        await store.account.cache([
            {
                address: this.asset.packetId,
            },
            {
                address: this.senderId,
            }
        ]);
    }

    validateAsset() {
        // Static checks for presence of `packetId`, `postage`, `security`, and `minTrust`.
        const errors = [];
        if (!this.asset.packetId || typeof this.asset.packetId !== 'string') {
            errors.push(
                new TransactionError(
                    'Invalid "asset.packetId" defined on transaction',
                    this.id,
                    '.asset.packetId',
                    this.asset.packetId
                )
            );
        }
        if (!this.asset.postage || typeof this.asset.postage !== 'string') {
			errors.push(
				new TransactionError(
					'Invalid "asset.postage" defined on transaction',
					this.id,
					'.asset.postage',
					this.asset.postage,
					'A string value',
				)
			);
        }
        if (!this.asset.security || typeof this.asset.security !== 'string') {
			errors.push(
				new TransactionError(
					'Invalid "asset.security" defined on transaction',
					this.id,
					'.asset.security',
					this.asset.security,
					'A string value',
				)
			);
        }
        if (typeof this.asset.minTrust !== 'number' || isNaN(parseFloat(this.asset.minTrust)) || !isFinite(this.asset.minTrust)) {
			errors.push(
				new TransactionError(
					'Invalid "asset.minTrust" defined on transaction',
					this.id,
					'.asset.minTrust',
					this.asset.minTrust,
					'A number value',
				)
			);
		}
        return errors;
    }

    async applyAsset(store) {
        const errors = [];
        const packet = await store.account.get(this.asset.packetId);

        if (!packet.asset.status) {
            /* --- Modify sender account --- */
            /**
             * Update the sender account:
             * - Deduct the postage from senders' account balance
             */
            const sender = await store.account.get(this.senderId);
            sender.balance = BigInt(sender.balance) - BigInt(this.asset.postage);

            store.account.set(sender.address, sender);

            /* --- Modify packet account --- */
            /**
             * Update the packet account:
             * - Add the postage to the packet account balance
             * - Add all important data about the packet inside the asset field:
             *   - recipient: ID of the packet recipient
             *   - sender: ID of the packet sender
             *   - carrier: ID of the packet carrier
             *   - security: Number of tokens the carrier needs to lock during the transport of the packet
             *   - postage: Number of tokens the sender needs to pay for transportation of the packet
             *   - minTrust: Minimal trust that is needed to be carrier for the packet
             *   - status: Status of the transport (pending|ongoing|success|fail)
             */
            packet.balance = packet.balance + BigInt(this.asset.postage);

            packet.asset = {
                recipient: this.asset.recipientId,
                sender: this.senderId,
                security: this.asset.security,
                postage: this.asset.postage,
                minTrust: this.asset.minTrust.toString(),
                status: 'pending',
                carrier: null
            };
            store.account.set(packet.address, packet);
        } else {
            errors.push(
                new TransactionError(
                    'packet has already been registered',
                    packet.asset.status
                )
            );
        }
        return errors;
    }

    async undoAsset(store) {
        const errors = [];

        /* --- Revert sender account --- */
        const sender = await store.account.get(this.senderId);
        sender.balance = sender.balance + BigInt(this.asset.postage);

        store.account.set(sender.address, sender);

        /* --- Revert packet account --- */
        const packet = await store.account.get(this.asset.packetId);
        packet.balance = BigInt("0");
        packet.asset = null;
        store.account.set(packet.address, packet);

        return errors;
    }

}

module.exports = RegisterPacketTransaction;</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="task-complete-the-implementation-of-the-undoasset-function"><a class="anchor" href="#task-complete-the-implementation-of-the-undoasset-function"></a>Task: Complete the implementation of the <code>undoAsset</code> function.</h3>
<div class="paragraph">
<p>Please note a small part of the logic is missing whereby the packet account was reset to its original state.</p>
</div>
<div class="paragraph">
<p>Now try to implement the <a href="https://github.com/LiskHQ/lisk-sdk-examples/blob/v4/transport/transactions/register-packet.js#L160" target="_blank" rel="noopener">missing logic</a> for <code>undoAsset()</code> by reverting the steps of the <code>applyAsset()</code> function.</p>
</div>
<div class="paragraph">
<p><strong>Important: To verify the implementation of <code>undoAsset()</code>, compare it with the <a href="https://github.com/LiskHQ/lisk-sdk-examples/blob/v4/transport/transactions/solutions/register-packet.js" target="_blank" rel="noopener">solution</a>.</strong></p>
</div>
</div>
<div class="sect2">
<h3 id="explanation-undoassetstore"><a class="anchor" href="#explanation-undoassetstore"></a>Explanation: <code>undoAsset(store)</code></h3>
<div class="paragraph">
<p>The <code>undoAsset</code> function is responsible for informing the blockchain how to revert changes that have been applied via the <code>applyAsset</code> function.
This is very useful in case of a fork whereby it is necessary to change to a different chain.
In order to accomplish this it is necessary to roll back blocks and apply new blocks of a new chain.
Hence, when rolling back blocks it is necessary to update the account state of the affected accounts.
Please note that this is the reason why writing the logic for the <code>undoAsset</code> function should never be skipped.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="3-1-start-the-transport"><a class="anchor" href="#3-1-start-the-transport"></a>3.1 Start the transport</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For the next step it is now required to implement the <code>StartTransport</code> transaction.
This transaction indicates the start of the transportation as the carrier picks up the package from the sender.</p>
</div>
<div class="paragraph">
<p>When creating the <code>StartTransport</code> transaction, the carrier defines the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>packetId</code>: The ID of the packet that the carrier is going to transport.
The <code>packetId</code> is not sent in the asset field, but is assigned to the <code>recipientId</code> property of the transaction.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This transaction will perform the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Lock the specified <code>security</code> of the packet in the carrier&#8217;s account.
This security cannot be accessed by the carrier, unless the transport has been finished successfully.</p>
</li>
<li>
<p>Add the <code>carrier</code> to the packet account.</p>
</li>
<li>
<p>Set the <code>status</code> of the packet from <code>pending</code> to <code>ongoing</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>StartTransportTransaction</code> , the <code>prepare(),and the `undoAsset()</code> functions are described below, including implementing the security locking of the carriers account:</p>
</div>
<div class="listingblock">
<div class="title">Contents of start-transport.js</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-js hljs" data-lang="js">const {
    BaseTransaction,
    TransactionError
} = require('@liskhq/lisk-transactions');

class StartTransportTransaction extends BaseTransaction {

    static get TYPE () {
        return 21;
    }

    async prepare(store) {
        await store.account.cache([
            {
                address: this.asset.recipientId,
            },
            {
                address: this.senderId,
            }
        ]);
    }

    validateAsset() {
        const errors = [];

        return errors;
    }

    async applyAsset(store) {
        const errors = [];
        const packet = await store.account.get(this.asset.recipientId);
        if (packet.asset.status === "pending"){
            const carrier = await store.account.get(this.senderId);
            // If the carrier has the trust to transport the packet
            const carrierTrust = carrier.asset.trust ? carrier.asset.trust : '0';
            if (BigInt(packet.asset.minTrust) &lt;= BigInt(carrierTrust) &amp;&amp; carrier.balance &gt;= BigInt(packet.asset.security)) {
                /**
                 * Update the Carrier account:
                 * - Lock security inside the account
                 * - Remove the security from balance
                 * - initialize carriertrust, if not present already
                 */
                carrier.balance = { /* Write your code here */ };
                carrier.asset = { /* Write your code here */ };
                store.account.set(carrier.address, carrier);
                /**
                 * Update the Packet account:
                 * - Set status to "ongoing"
                 * - set carrier to ID of the carrier
                 */
                packet.asset.status = "ongoing";
                packet.asset.carrier = carrier.address;
                store.account.set(packet.address, packet);
            } else {
                errors.push(
                    new TransactionError(
                        'carrier has not enough trust to deliver the packet, or not enough balance to pay the security',
                        packet.asset.minTrust,
                        carrier.asset.trust,
                        packet.asset.security,
                        carrier.balance.toString()
                    )
                );
            }
        } else {
            errors.push(
                new TransactionError(
                    'packet status needs to be "pending"',
                    packet.asset.status
                )
            );
        }

        return errors;
    }

    async undoAsset(store) {
        const errors = [];
        const packet = await store.account.get(this.asset.packetId);
        const carrier = await store.account.get(this.senderId);
        /* --- Revert carrier account --- */
        carrier.balance = carrier.balance + BigInt(packet.asset.security);

        store.account.set(carrier.address, carrier);
        /* --- Revert packet account --- */
        packet.asset = {
            deliveryStatus: "pending",
            carrier: null
        };
        store.account.set(packet.address, packet);
        return errors;
    }

}

module.exports = StartTransportTransaction;</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="task-lock-funds"><a class="anchor" href="#task-lock-funds"></a>Task: Lock funds</h3>
<div class="paragraph">
<p>To lock the funds, simply deduct the number of tokens locked from the account&#8217;s balance.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-js hljs" data-lang="js">const carrierBalanceWithoutSecurity = carrierBalance - packetSecurity;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, store the deducted number of tokens in a custom property in the <code>asset</code> field.
This provides the ability to keep track of the amount of tokens locked as security.</p>
</div>
<div class="paragraph">
<p><a href="https://github.com/LiskHQ/lisk-sdk-examples/blob/v4/transport/transactions/start-transport.js#L53" target="_blank" rel="noopener">Insert your own code here</a>:
Create an updated object for the carrier account that substracts the <code>security</code> from the carriers balance, and add a new property <code>lockedSecurity</code> to the <code>asset</code> field of the carriers account.
The <code>lockedSecurity</code> should exactly equal the amount deducted from the carriers <code>balance</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
To unlock locked tokens, remove or nullify the custom property in the <code>asset</code> field and add the number of tokens again to the account&#8217;s <code>balance</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><strong>Important: To verify the implementation, please compare it with the <a href="https://github.com/LiskHQ/lisk-sdk-examples/blob/v4/transport/transactions/solutions/start-transport.js" target="_blank" rel="noopener">solution</a>.</strong></p>
</div>
</div>
<div class="sect2">
<h3 id="explanation-prepare"><a class="anchor" href="#explanation-prepare"></a>Explanation: <code>prepare()</code></h3>
<div class="paragraph">
<p>The prepare function here is caching both the carrier account through the <code>senderId</code> and the packet account through the <code>recipientId</code>.</p>
</div>
<div class="paragraph">
<p><em>Why is it possible to cache two accounts at the same time?</em> Please notice that the cache function accepts an array which allows it to pass in multiple query objects.
When a pass in an array to the cache function is made, it will try to find a result for each query object.</p>
</div>
<div class="paragraph">
<p>It is also possible to pass in just one query object without a surrounding array.
In this case, only objects that exactly match this query object will be cached as shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-js hljs" data-lang="js">async prepare(store) {
        await store.account.cache([
            {
                address: this.asset.recipientId,
            },
            {
                address: this.senderId,
            }
        ]);
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>A further in depth explanation in the custom transactions deep dive article can be found on <a href="https://lisk.io/blog/tutorial/custom-transactions-statestore-basetransaction-transfer-transaction#6658" target="_blank" rel="noopener">our blog</a>.
The link opens the section <code>B/ Combining Filters</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="3-2-finish-the-transport"><a class="anchor" href="#3-2-finish-the-transport"></a>3.2 Finish the transport</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The last custom transaction required to be implemented is the <code>FinishTransportTransaction</code>, which will complete the transport of the packet.</p>
</div>
<div class="paragraph">
<p>When reaching the recipient of the packet, the carrier passes the packet to the recipient.
The recipient needs to sign the <code>FinishTransportTransaction</code>, this verifies that the packet has been passed on to the recipient.</p>
</div>
<div class="paragraph">
<p>When sending the transaction, the recipient needs to specify the following criteria:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>packetID</code>: The ID of the packet that the recipient received.</p>
</li>
<li>
<p><code>status</code>: The status of the transport, which has 2 options: <code>"success"</code> or <code>"fail"</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This transaction will perform the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If <code>status="success"</code></p>
<div class="ulist">
<ul>
<li>
<p>Send <code>postage</code> to the carrier&#8217;s account.</p>
</li>
<li>
<p>Unlock <code>security</code> in the carrier&#8217;s account.</p>
</li>
<li>
<p>Increase <code>trust</code> of the carrier +1.</p>
</li>
<li>
<p>Set packet <code>status</code> to <code>success</code>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>If <code>status="fail"</code></p>
<div class="ulist">
<ul>
<li>
<p>Send <code>postage</code> to the sender&#8217;s account.</p>
</li>
<li>
<p>Add <code>security</code> to the sender&#8217;s account, and nullify <code>lockedSecurity</code> from the account for the carrier.</p>
</li>
<li>
<p>Decrease <code>trust</code> of the carrier by -1.</p>
</li>
<li>
<p>Set packet <code>status</code> to <code>fail</code>.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Click here to see the <a href="https://github.com/LiskHQ/lisk-sdk-examples/blob/v4/transport/transactions/finish-transport.js" target="_blank" rel="noopener">full code for FinishTransportTransaction</a></p>
</div>
<div class="listingblock">
<div class="title">Code for <code>applyAsset()</code> of <code>finish-transport.js</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-js hljs" data-lang="js">async applyAsset(store) {
    const errors = [];
    let packet = await store.account.get(this.asset.packetId);
    let carrier = await store.account.get(packet.asset.carrier);
    let sender = await store.account.get(packet.asset.sender);
    // if the transaction has been signed by the packet recipient
    if (this.senderId === packet.asset.recipient) {
        // if the packet status isn't "ongoing" or "alarm"
        if (packet.asset.status !==  "ongoing" &amp;&amp; packet.asset.status !== "alarm") {
            errors.push(
                new TransactionError(
                    'FinishTransport can only be triggered, if packet status is "ongoing" or "alarm" ',
                    this.id,
                    'ongoing or alarm',
                    this.asset.status
                )
            );
            return errors;
        }
        // if the transport was a success
        if ( this.asset.status === "success") {
            /**
             * Update the Carrier account:
             * - Unlock security
             * - Add postage &amp; security to balance
             * - Earn 1 trustpoint
             */
            carrier.balance = carrier.balance + BigInt(packet.asset.security) + BigInt(packet.asset.postage);
            const trustInc = carrier.asset.trust ? BigInt(carrier.asset.trust) + BigInt(1) : BigInt(1);

            carrier.asset = {
                ...carrier.asset,
                trust: trustInc.toString(),
                lockedSecurity: null
            };

            store.account.set(carrier.address, carrier);
            /**
             * Update the Packet account:
             * - Remove postage from balance
             * - Change status to "success"
             */
            packet.balance = BigInt(0);
            packet.asset = {
                ...packet.asset,
                status: 'success'
            }

            store.account.set(packet.address, packet);
            return errors;
        }
        // if the transport failed
        /**
         * Update the Sender account:
         * - Add postage and security to balance
         */
        sender.balance = sender.balance + BigInt(packet.asset.security) + BigInt(packet.asset.postage);

        store.account.set(sender.address, sender);
        /**
         * Update the Carrier account:
         * - Reduce trust by 1
         * - Set lockedSecurity to 0
         */
        const trustDec = carrier.asset.trust ? BigInt(carrier.asset.trust) - BigInt(1) : BigInt(-1);
        carrier.asset = {
            ...carrier.asset,
            trust: trustDec.toString(),
            lockedSecurity: null
        };

        store.account.set(carrier.address, carrier);
        /**
         * Update the Packet account:
         * - set status to "fail"
         * - Remove postage from balance
         */
        packet.balance = BigInt('0');
        packet.asset = {
            ...packet.asset,
            status: 'fail'
        };

        store.account.set(packet.address, packet);

        return errors;
    }
    errors.push(
        new TransactionError(
            'FinishTransport transaction needs to be signed by the recipient of the packet',
            this.id,
            '.asset.recipient',
            this.asset.recipient
        )
    );
    return errors;
}</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="explanation-caching-data-based-on-data-from-the-db"><a class="anchor" href="#explanation-caching-data-based-on-data-from-the-db"></a>Explanation: Caching data based on data from the db</h3>
<div class="paragraph">
<p>It may be required to cache accounts or other data from the database, depending on other data that is stored in the database.</p>
</div>
<div class="paragraph">
<p>To achieve this, the points listed below must be followed:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Cache the data with <code>store.account.cache</code>.</p>
</li>
<li>
<p>Save the data as a constant with <code>store.account.get</code>.</p>
</li>
<li>
<p>It is now possible to use the newly created constant to cache the rest of the data, as shown in the code snippet below:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title"><code>prepare()</code> function of <code>finish-transport.js</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-js hljs" data-lang="js">async prepare(store) {
    /**
     * Get packet account
     */
    await store.account.cache([
        {
            address: this.asset.packetId,
        }
    ]);
    /**
     * Get sender and recipient accounts of the packet
     */
    const pckt = await store.account.get(this.asset.packetId);
    await store.account.cache([
        {
            address: pckt.asset.carrier,
        },
        {
            address: pckt.asset.sender,
        },
    ]);
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="task-implement-the-logic-in-applyasset-for-a-successful-transport"><a class="anchor" href="#task-implement-the-logic-in-applyasset-for-a-successful-transport"></a>Task: Implement the logic in <code>applyAsset()</code> for a successful transport</h3>
<div class="paragraph">
<p><a href="https://github.com/LiskHQ/lisk-sdk-examples/blob/v4/transport/transactions/finish-transport.js#L83" target="_blank" rel="noopener">Write your own logic or the case of a successful transport of the packet here.</a></p>
</div>
<div class="paragraph">
<p>When the recipient receives the packet from the carrier, the recipient has to sign and send the <code>FinishTransportTransaction</code>.
If the recipient considers the transport successful, then the carrier should be rewarded accordingly and the packet status will be updated to <code>success</code>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
More information can be found in the code comments of <code>finish-transport.js</code>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><strong>Important: To verify your implementation of <code>applyAsset()</code>, please compare it with the <a href="https://github.com/LiskHQ/lisk-sdk-examples/blob/v4/transport/transactions/solutions/finish-transport.js" target="_blank" rel="noopener">solution</a>.</strong></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="3-3-test-out-the-full-workflow-with-the-client-app"><a class="anchor" href="#3-3-test-out-the-full-workflow-with-the-client-app"></a>3.3 Test out the full workflow with the client app</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="check_status"><a class="anchor" href="#check_status"></a>Check the status in the <code>lightAlarmTransaction</code></h3>
<div class="paragraph">
<p>At this point the entire workflow should be implemented with the status of the different packets.
If a packet is currently in <code>ongoing</code>  or <code>alarm</code> status, then to send an alarm follow the instructions described below:</p>
</div>
<div class="paragraph">
<p>Insert the code snippet listed below in the <code>applyAsset()</code> function of <a href="https://github.com/LiskHQ/lisk-sdk-examples/blob/v4/transport/transactions/light-alarm.js#L39" target="_blank" rel="noopener">light-alarm.js</a>, before the code that applies the changes to the database accounts.</p>
</div>
<div class="paragraph">
<p>If the status is not in <code>ongoing</code> or <code>alarm</code>, it will create a new <code>TransactionError</code>, push it to the <code>errors</code> list, and then return it.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
This snippet must be inserted twice: Once in <code>transaction/light-alarm.js</code> on the local machine, and also in the <code>light-alarm.js</code> on the raspberry pi.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-js hljs" data-lang="js">const packet = store.account.get(this.senderId);
if (packet.asset.status !== 'ongoing' &amp;&amp; packet.asset.status !== 'alarm') {
    errors.push(
        new TransactionError(
            'Transaction invalid because delivery is not "ongoing".',
            this.id,
            'packet.asset.status',
            packet.asset.status,
            `Expected status to be equal to "ongoing" or "alarm"`,
        )
    );

    return errors;
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="register-all-transaction-types-with-the-node-app"><a class="anchor" href="#register-all-transaction-types-with-the-node-app"></a>Register all transaction types with the node app</h3>
<div class="paragraph">
<p>Please follow the required steps below to uncomment all of the custom transactions, in order to register them with the node application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-js hljs" data-lang="js">const { Application, genesisBlockDevnet, configDevnet } = require('lisk-sdk');
const RegisterPacketTransaction = require('../transactions/register-packet');
const StartTransportTransaction = require('../transactions/start-transport');
const FinishTransportTransaction = require('../transactions/finish-transport');
const LightAlarmTransaction = require('../transactions/light-alarm');

configDevnet.label = 'lisk-transport';
configDevnet.modules.http_api.access.public = true;

const app = new Application(genesisBlockDevnet, configDevnet);
app.registerTransaction(RegisterPacketTransaction);
app.registerTransaction(StartTransportTransaction);
app.registerTransaction(FinishTransportTransaction);
app.registerTransaction(LightAlarmTransaction);

app
    .run()
    .then(() =&gt; app.logger.info('App started...'))
    .catch(error =&gt; {
        console.error('Faced error in application', error);
        process.exit(1);
    });</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="try-it-out-in-the-client-app"><a class="anchor" href="#try-it-out-in-the-client-app"></a>Try it out in the client app</h3>
<div class="paragraph">
<p>Now try to start or re-start the <code>node</code>, <code>client</code> and <code>iot</code> application, exactly as performed earlier in <a href="part2.html#client" class="xref page">Step 2.3 in Part 2</a> of this tutorial.</p>
</div>
<div class="paragraph">
<p>Go to <code><a href="http://localhost:3000" class="bare">http://localhost:3000</a></code> to access the client app through the web browser.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The prepared account credentials for the sender, recipient, and carrier can be found in <code>client/accounts.json</code>.</p>
</div>
<div class="paragraph">
<p>These credentials are already pre-filled in the different forms in the client app.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">The different users in Lisk transport can be seen below:</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "carrier": {
    "passphrase": "endless focus guilt bronze hold economy bulk parent soon tower cement venue",
    "privateKey": "a30c9e2b10599702b985d18fee55721b56691877cd2c70bbdc1911818dabc9b9508a965871253595b36e2f8dc27bff6e67b39bdd466531be9c6f8c401253979c",
    "publicKey": "508a965871253595b36e2f8dc27bff6e67b39bdd466531be9c6f8c401253979c",
    "address": "8531579280410192796L"
  },
  "recipient": {
    "passphrase": "mushroom edit regular pencil ten casino wine north vague bachelor swim piece",
    "privateKey": "a0b281d0449f9c2977f5fa40114c1c7e1550ff3c785bcdb1ac25f64a1c627154a9a3c363a71a3089566352127cf0e6f79d3834e1d67b4132b98d35afd3b85375",
    "publicKey": "a9a3c363a71a3089566352127cf0e6f79d3834e1d67b4132b98d35afd3b85375",
    "address": "7700165370820050502L"
  },
  "sender": {
    "address": "5059876081639179984L",
    "passphrase": "peanut hundred pen hawk invite exclude brain chunk gadget wait wrong ready"
  }
}</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="initialize-a-new-packet-account"><a class="anchor" href="#initialize-a-new-packet-account"></a>Initialize a new packet account</h4>
<div class="paragraph">
<p>Go to <code><a href="http://localhost:3000/initialize" class="bare">http://localhost:3000/initialize</a></code> and copy the packet credentials <a href="https://github.com/LiskHQ/lisk-sdk-examples/blob/v4/transport/iot/light_alarm/index.js#L18" target="_blank" rel="noopener">in your tracking script</a> on the Raspberry Pi.</p>
</div>
<div class="paragraph">
<div class="title">Create new packet credentials</div>
<p><span class="image"><img src="../../_images/1-initialize.png" alt="Initialize packet account"></span></p>
</div>
</div>
<div class="sect3">
<h4 id="register-the-packet"><a class="anchor" href="#register-the-packet"></a>Register the packet</h4>
<div class="paragraph">
<p>Firstly, open the <a href="http://localhost:3000/post-register-packet">Register Packet</a> page and complete the form in order to register your packet in the network.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Use the address of the packet credentials as the packet ID that was created in the previous step.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Set <code>minTrust</code> to <code>0</code>, as there is no carrier present in the system yet that has more than <code>0</code> trustpoints.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Sender posts the <code>RegisterPacket</code> transaction to register the packet on the network.</div>
<p><span class="image"><img src="../../_images/2-register.png" alt="register packet"></span></p>
</div>
<div class="paragraph">
<div class="title">Check the <code>Packet &amp; Carrier</code> page to see if the packet status is now "pending"</div>
<p><span class="image"><img src="../../_images/3-pending.png" alt="packet pending"></span></p>
</div>
<div class="paragraph">
<p>If the packet is now opened at this point, then the light alarm transaction should fail as the packet should have the wrong <code>status</code>.
It should display the following error message:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-js hljs" data-lang="js">[
  {
    "message": "Transaction invalid because delivery is not \"ongoing\".",
    "name": "TransactionError",
    "id": "5902807582253136271",
    "dataPath": "packet.asset.status",
    "actual": "pending",
    "expected": "Expected status to be equal to \"ongoing\" or \"alarm\""
  }
]</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="fund-the-carrier-account"><a class="anchor" href="#fund-the-carrier-account"></a>Fund the carrier account</h4>
<div class="paragraph">
<p>Before the packet transport starts, it is necessary to transfer some tokens into the empty carrier account.
This is required as the carrier needs to lock the <code>security</code> in the carriers account, in order to start the transport.</p>
</div>
<div class="paragraph">
<p>To perform this task, go to the <a href="http://localhost:3000/faucet">Faucet page</a> and enter the carrier address(<code>6795425954908428407L</code>), followed by the amount of tokens to be transferred to this account.</p>
</div>
<div class="paragraph">
<p>Please ensure that enough tokens are transferred so that the carrier can afford to lock the <code>security</code> of the packet, that was defined in the previous step whereby the packet was registered in the network.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
This can be checked on the <code>Accounts</code> page, to see if the carrier received the tokens successfully.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><span class="image"><img src="../../_images/4-faucet.png" alt="Fund carrier"></span></p>
</div>
</div>
<div class="sect3">
<h4 id="start-transport"><a class="anchor" href="#start-transport"></a>Start transport</h4>
<div class="paragraph">
<p>The carrier is required to post the transaction on the <a href="http://localhost:3000/post-start-transport">Start Transport</a> page in order  to initiate the transport.</p>
</div>
<div class="paragraph">
<p>The carrier is now required to specify the <code>packetId</code>.</p>
</div>
<div class="paragraph">
<p>The transaction will only be accepted if the carrier has enough <code>trust</code> and <code>security</code> for the specified packet.</p>
</div>
<div class="paragraph">
<div class="title">Carrier posts the <code>StartTransport</code> transaction, and then receives the packet from the sender.</div>
<p><span class="image"><img src="../../_images/5-start.png" alt="start transport"></span></p>
</div>
<div class="paragraph">
<div class="title">API response</div>
<p><span class="image"><img src="../../_images/22-register-response.png" alt="finish transport"></span></p>
</div>
<div class="paragraph">
<div class="title">Check the <code>Packet &amp; Carrier</code> page to see if the packet status has changed to "ongoing".</div>
<p><span class="image"><img src="../../_images/6-ongoing.png" alt="packet account 2"></span></p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The light alarm will be extinguished after posting the  <code>StartTransport</code> and before posting the <code>FinishTransport</code>.
This occurs due to the status check added in the section <a href="#check_status">Check for status in the lightAlarmTransaction</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><span class="image"><img src="../../_images/7-alarm.png" alt="packet alarm"></span></p>
</div>
</div>
<div class="sect3">
<h4 id="finish-transport"><a class="anchor" href="#finish-transport"></a>Finish transport</h4>
<div class="paragraph">
<p>When the carrier passes the packet to the recipient, the recipient will sign the final <a href="http://localhost:3000/post-finish-transport">FinishTransport</a> transaction, which will complete the transport of the packet.</p>
</div>
<div class="paragraph">
<p>Only the <code>packetId</code>, and the <code>status</code>, which can be either <code>fail</code> or <code>success</code> needs to be specified here.</p>
</div>
<div class="paragraph">
<p>To help with the decision of the final status, the recipient can inspect the packet after receiving it.
Please be aware that due to the IoT device inside the packet, the recipient can also check in the client app if the packet triggered any alarm.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In case the recipient does not receive the packet after a reasonable amount of time, the recipient should also send the <code>FinishTransport</code> transaction, (most likely with <code>status=fail</code>).
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">The recipient posts the <code>FinishTransport</code> transaction, once the packet has been received from the carrier.</div>
<p><span class="image"><img src="../../_images/8-finish.png" alt="finish transport"></span>
Check if the transport has been successful or if it has failed, then verify the changes accordingly in the accounts on the <code>Packet&amp;Carrier</code> page.</p>
</div>
<div class="paragraph">
<div class="title">Transport fail</div>
<p><span class="image"><img src="../../_images/9-fail.png" alt="finish transport fail"></span></p>
</div>
<div class="paragraph">
<div class="title">API response</div>
<p><span class="image"><img src="../../_images/92-success.png" alt="finish transport"></span></p>
</div>
<div class="paragraph">
<p>Once all of the above steps have been completed, a simple and fully working proof of concept of a decentralized supply chain tracking system is now running on your machine.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Time to celebrate! \o/
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="part2.html">Part 2: Track a packet on the blockchain</a></span>
  <span class="next"><a href="part4.html">Part 4: How to publish the application</a></span>
</nav>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <div class="footerdiv">
    <p>© 2022 Lisk Foundation</p>
    <!-- <div class="community-section">
      <p class="community-section__text">Follow Lisk on: </p>
      <div class="community-section__icons"> -->
    <div class="community_icons">
        <a href="https://lisk.chat" title="Discord" target="_blank" class="footer_icon icon-discord"><p>Discord</p></a>
        <a href="https://dev.lisk.com" title="Discourse" target="_blank" class="footer_icon icon-discourse"><p>Discourse</p></a>
        <a href="https://github.com/LiskHQ" title="GitHub" target="_blank" class="footer_icon icon-github"><p>GitHub</p></a>
  <!--    </div> -->
    </div>
  </div>
</footer>
<script src="../../../../_/js/site.js"></script>
<script async src="../../../../_/js/vendor/highlight.js"></script>
<script async src="../../../../_/js/vendor/tabs-block-behaviour.js"></script>
<script async src="../../../../_/js/vendor/swagger-ui.js"></script>
<script async src="../../../../_/js/vendor/component-versions.js"></script>
<script src="../../../../_/js/vendor/custom.js"></script>
  <script src="../../../../_/js/vendor/docsearch.js"></script>
  <!--<script src="../../../../_/js/vendor/docsearch.min.js"></script>-->
  <!--<script src="https://cdn.jsdelivr.net/npm/@docsearch/js@alpha"></script>-->
  <script>
    docsearch({
      container: '#docsearch',
        appId: 'C4SU57KGV9',
      apiKey: '55aa8709b04eb62f08f87571cf77547c',
      indexName: 'lisk-docs-search'
    });
    docsearch({
      container: '#docsearch-toolbar',
        appId: 'C4SU57KGV9',
      apiKey: '55aa8709b04eb62f08f87571cf77547c',
      indexName: 'lisk-docs-search'
    });
  </script>
  <!--<script>
    function focusSearchInput () { document.querySelector('#search-input').focus() }
    var search = docsearch({
        appId: 'C4SU57KGV9',
      apiKey: '55aa8709b04eb62f08f87571cf77547c',
      indexName: 'lisk-docs-search',
      inputSelector: '#search-input',
      autocompleteOptions: { hint: false, keyboardShortcuts: ['s'] },
      algoliaOptions: { hitsPerPage: 10 }
    }).autocomplete
    search.on('autocomplete:closed', function () { search.autocomplete.setVal() })
    focusSearchInput()
    window.addEventListener('load', focusSearchInput)
  </script>-->
<!--  <script>
    function focusSearchInputToolbar () { document.querySelector('#search-input-toolbar').focus() }
    var search = docsearch({
        appId: 'C4SU57KGV9',
      apiKey: '55aa8709b04eb62f08f87571cf77547c',
      indexName: 'lisk-docs-search',
      inputSelector: '#search-input-toolbar',
      autocompleteOptions: { hint: false, keyboardShortcuts: ['s'] },
      algoliaOptions: { hitsPerPage: 10 }
    }).autocomplete
    search.on('autocomplete:closed', function () { search.autocomplete.setVal() })
    focusSearchInputToolbar()
    window.addEventListener('load', focusSearchInputToolbar)
  </script>-->
  </body>
</html>
