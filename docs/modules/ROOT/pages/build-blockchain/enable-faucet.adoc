= How to enable a Faucet for testing
Mona Bärenfänger <mona@lightcurve.io>
// Settings
:toc: preamble
:imagesdir: ../../../assets/images
:idprefix:
:idseparator: -
:sectnums:
:experimental:
:docs_sdk: v6@lisk-sdk::
// URLs
:url_recaptcha_keys: https://developers.google.com/recaptcha/docs/faq#id-like-to-run-automated-tests-with-recaptcha.-what-should-i-do
:url_faucet: http://localhost:4004
:url_dashboard: http://localhost:4005
// Project URLS
:url_plugin_faucet: {docs_sdk}plugins/faucet-plugin.adoc
:url_guide_dashboard: build-blockchain/using-dashboard.adoc
:url_guide_genesisblock: build-blockchain/create-genesis-block.adoc

// TODO: Update the page by uncommenting the hyperlinks once the updated pages are available. 

The xref:{url_plugin_faucet}[Faucet plugin] provides a user interface in the browser to receive a certain amount of tokens on request.
The Faucet plugin is a useful tool to use in devnets or testnets.

The Faucet plugin includes the following features:

* It enables sending tokens to different accounts from a faucet for testing.
* It allows customizing the faucet UI with a custom logo and application URL.

One account is always connected to the faucet, to provide the tokens to be distributed through the faucet.
To prevent the faucet from running dry, the faucet account should always have an adequate enough balance to be able to provide the requested tokens to users.

== Installation

To register the Faucet plugin, first install it with NPM:

[source,bash]
----
npm i @liskhq/lisk-framework-faucet-plugin
----

Now open `plugins.ts`, import the Faucet plugin, and register it with the application as shown below:

.src/app/plugins.ts
[source,typescript]
----
/* eslint-disable @typescript-eslint/no-empty-function */
import { Application } from 'lisk-sdk';
import { FaucetPlugin } from "@liskhq/lisk-framework-faucet-plugin";
// @ts-expect-error Unused variable error happens here until at least one module is registered
export const registerPlugins = (app: Application): void => {
    app.registerPlugin(FaucetPlugin);
};
----

Save and close `plugins.ts`.

== Configuration

Choose one account with a high enough token balance as the token source for the faucet.
For example, use one of the genesis validators for the faucet account, e.g., the first account in `dev-validators.json` which was generated during xref:{url_guide_genesisblock}[].

NOTE: Multiple accounts can be created using the same passphrase, and can be differentiated with the `keyPath`.

.dev-validators.json
[source,js]
----
[
		{
			"address": "lskuxraqembhgy7cywjnqx72jsoamutvfpo26vnku",
			"keyPath": "m/44'/134'/0'",
			"publicKey": "b7fa122a36445389458ffa2063b145849fc8a72b78a4b460de17e34fa1ef9022",
			"privateKey": "8f8b7aaede91ff3aa9d18cf720e2703c6afd3f5452abc8a7c810a4750dbedcd8b7fa122a36445389458ffa2063b145849fc8a72b78a4b460de17e34fa1ef9022",
			"plain": {
				"generatorKeyPath": "m/25519'/134'/0'/0'",
				"generatorKey": "6c3ead4da31ad13af9e1667b3cdd1cbad6d7249969638707b47f0b04d4775030",
				"generatorPrivateKey": "7821652825f321e747069c7ad7b0e1bfb36ef1440a268bbb9715808d302e7b096c3ead4da31ad13af9e1667b3cdd1cbad6d7249969638707b47f0b04d4775030",
				"blsKeyPath": "m/12381/134/0/0",
				"blsKey": "8695ff86ae1540c6004443d35cb47d2575547a443079676e449f24a057b8577b8766e82e265a431628b3af95d8349778",
				"blsProofOfPossession": "8b16a53bcea0d6d94485e3eb29d7a782dabee5743faae571305c404bb06596230f0ec81044e7487195342f7d5617385d10ba3c898fde94a3e62ed5d7cbdfb471c352d41859a65fbbeeaeaf7bfaa167fcc6db33a22d37ab4defc3e9f4abf4ddac",
				"blsPrivateKey": "03cc560bc547b653f9a9784e82134242ba22c16d1920e4cca170a7c6307a3477"
			},
			"encrypted": {}
		},
]
----

Use Lisk Commander to encrypt the passphrase of the account with a password.
Save the password securely as it will be required to enable and disable the faucet later.

[source,bash]
----
lisk message:encrypt "d0b159fe5a7cc3d5f4b39a97621b514bc55b0a0f1aca8adeed2dd1899d93f103a3f96c50d0446220ef2f98240898515cbba8155730679ca35326d98dcfb680f0" --pretty
? Please enter password:  [hidden]
? Please re-enter password:  [hidden]
{
  "ciphertext": "026e354440b9a94476fcda802bab7cff00be291b3a2e9f28b74b03bcc4da3475a0139e6f261799733ea689ddf0b8e1c34cac539d234e4c6c700bc3b229ed5088f3a93dcca10b575a8d7ea46cad9d94094a9a12fb35f0bce241dd13c40e78307ce42100db812997feadfa82b4efd3dc305cd1625ea2a507c126c77c2378fdddd1",
  "mac": "acdbeb1d39cf93d393b9a43c4d9d35f8238eb9bea4ebcd40d5f19194ba22b792",
  "kdf": "argon2id",
  "kdfparams": {
    "parallelism": 4,
    "iterations": 1,
    "memorySize": 2097023,
    "salt": "cd1be2d9a69fecea"
  },
  "cipher": "aes-128-gcm",
  "cipherparams": {
    "iv": "44841203bf78e32e04d1f4d618f200c5",
    "tag": "784edea6344a52c1b974be9f5cc2c4e8"
  },
  "version": "1"
}
----

Choose a simple password to encrypt the `privateKey` symmetrically.
The password will be required later to enable the faucet plugin through the action `faucet:authorize`.

Open the config file of the sidechain client and scroll down to the bottom of the file.
Add the required configuration options for the faucet plugin under the key `plugins.faucet`:

// * `encryptedPrivateKey`: The encrypted private key of the account that will provide the tokens for the faucet.
// * `captchaSecretkey`: The secret API key for the captcha.
// * `captchaSitekey`: The API site key for the captcha.


The following values listed below can be configured if required:

[types.ts]
----
 {
	port: number; <1>
	host: string; <2>
	encryptedPrivateKey: string; <3>
	tokenID: string; <4>
	captchaSitekey: string; <5>
	captchaSecretkey: string; <6>
	applicationUrl: string; <7>
	fee: string; <8>
	amount: string; <9>
	tokenPrefix: string; <10>
	captchaSecret: string; <11>
	logoURL?: string; <12>
}
----

<1> `port`: Port of the Faucet plugin.
<2> `host`: Host address of the Faucet plugin.
<3> `encryptedPrivateKey`: The encrypted private key of the account that will provide the tokens for the faucet.
<4> `tokenID`:  A unique identifier for the tokens.
<5> `captchaSitekey`: The API site key for the CAPTCHA.
<6> `captchaSecretkey`: The secret API key for the CAPTCHA.
<7> `applicationUrl`: Web address where the Faucet app is located.
<8> `fee`: Fee for the transport transaction.
<9> `amount`: Amount of tokens to be transferred.
<10> `tokenPrefix`: A configurable prefix added to generated tokens for user identification and security.
<11> `captchaSecret`: A secret key used for integrating and verifying CAPTCHA challenges.
<12> `logoURL?`: Web address for any custom logo.

The following values listed below are the default values:

[types.ts]
----
default: {
        port: 4004,
        host: '127.0.0.1',
        applicationUrl: 'ws://localhost:7887/rpc-ws',
        fee: '0.1',
        amount: '100',
        tokenPrefix: 'lsk',
    },

----

The {url_recaptcha_keys}[free site key and secret key for reCAPTCHA^] are used below for testing purposes.
The following 3 properties below are mandatory requirements.

.~/.lisk/lns/config/default/config.json
[source,json]
----
"plugins": {
    "faucet": {
        "encryptedPrivateKey": "kdf=argon2id&cipher=aes-128-gcm&version=1&ciphertext=f4fdbc925fc8a30da86935e7d51d363623a9e3c5c2f865de73bd7ca24d9edf47f7849be1764f7cc9dfb797ecb72673ff81cb4371ff1a4261b2a5f7919a823249a8b933409c9a1723dfc66eba9ffba6e2374b3ed334acb582c7b12e11e9e87c44bf3154a4e83e55e39dde4a8d821f9078b709dfc80dd21aa58b3edd86894792fa&mac=d076e5d64f232f01a320cddf32325decd0a670f924e97378182d2331c932429b&salt=3e911dd3ef883677&iv=4952b61723622bdf86d9db8f6760f94c&tag=c5632106794c16b5625500a571272f41&iterations=1&parallelism=4&memorySize=2097023",
        "captchaSecretkey": "6LeIxAcTAAAAAGG-vFI1TnRWxMZNFuojJ4WifJWe",
        "captchaSitekey": "6LeIxAcTAAAAAJcZVRqyHh71UMIEGNQ_MXjiZKhI"
    }
}
----

Start the sidechain client again:

[source,bash]
----
./bin/run start
----

Wait until the application start is completed.

== Enable the Faucet plugin

[tabs]
====
Via the Dashboard plugin::
+
--
If the Dashboard plugin is enabled as described in the guide xref:{url_guide_dashboard}[], then the dashboard can be used to enable the Faucet plugin.

Go to {url_dashboard} to access the dashboard.

Now go to the `Call actions` section on the Dashboard, and select the action `faucet:authorize`.

image:tutorials/lns/faucet-authorize-action.png[faucet:authorize,400,100]

The action expects a boolean as an input defining if the plugin should be enabled, and also a password to decrypt the encrypted passphrase that was saved in `config.json` above.

Add the following JSON object to the field for the asset data:

[source,json]
----
{
    "enable": true,
    "password": "myPassword" // <1>
}
----

<1> Change this to the password used above to encrypt the passphrase in the Faucet plugin configuration.

Click on the kbd:[Submit] button to invoke the action.
It should now be possible to see the confirmation message that the action was invoked successfully.

image:tutorials/lns/faucet-authorize-success.png[faucet:authorize-success,400,100]

--
Via the JS script::
+
--
Alternatively, choose a different method to send an RPC request to the node, for example use the `apiClient` as described below.

Use the `apiClient` of the `lisk-client` package and write a small script to invoke the action:

[source,js]
----
const { apiClient } = require('@liskhq/lisk-client');
let clientCache;
const getClient = async () => {
  if (!clientCache) {
    clientCache = await apiClient.createWSClient('ws://localhost:8080/ws');
  }
  return clientCache;
};
const enableFaucet = async () => {
  const client = await getClient();
  const result = client.invoke('faucet:authorize',{"enable":true,"password":"password"});
  return result;
};
enableFaucet().then((val) => {
  console.log('val:',val);
});
----
--
====

It is now possible to use the faucet under {url_faucet} .

image:tutorials/lns/faucet.png[Faucet]
