= How to create multi-signature accounts and transactions
:toc: preamble
:idprefix:
:idseparator: -
:source-language: bash
:url_lisk_learn_create_account: https://lisk.com/learn/undefined/create-an-account

====
On this page, you'll learn:

* [x] How to create a multi-signature user account that is managed by multiple users
* [x] How to create and sign multi-signature transactions
====

== Intro
Multi-signature accounts are user accounts which are managed by a group of users.

As the name suggests, multi-signature accounts need multiple signatures of different members of the multi-signature group to send any transaction.

How many and which members exactly need to sign a transaction is defined during the <<how-to-create-a-multi-signature-account,registration>> of the multi-signature account.

NOTE: A multi-signature account can have 2-64 members.

== Use cases for multi-signature accounts

=== Decision Uniformity
A possible use case for multi-signature might be a family account, where family members manage the funds in the account collaboratively, or consider a corporation with four board of directors.
Each board member gains access to one private key.
No individual member can misuse the funds.
Thus, only the decisions agreed upon by majority members can be executed.

=== Escrow Transactions
In case two users get into a dispute, a multi-signature account could be created to solve it.

For example, Alice makes the payment but Bob does not provide the services or goods as promised.
In such a scenario, to resolve the dispute between users, a mutually trusted third party/arbiter steps in.

Considering the wallet is configured to be 2-of-3 multi-sig wallet, the third key in above case is given to the arbiter.
Based on arbiter’s judgment the funds can be given either to Alice or to Bob.

=== Two-Factor Authentication
If John creates a multi-sig wallet that requires two keys, John creates a two factor authentication mechanism to access the funds.
John can store the private keys on two different devices and the funds stored in John’s multisig wallet can be accessed only if both the keys are provided.

However, using multisig technology as two-factor authentication can be risky, especially if it is a set of 2-of-2 multisig address.
If one of the keys is lost, you will not be able to access your funds.
Thus, it is safer to use a 2-of-3 setup.

== How to create a multi-signature account

//TODO: Add link to typedocs Register multisig command once available
//A multi-signature account is created by sending a {}[Register Multisignature] transaction.
A multi-signature account is created by sending a Register Multisignature transaction.
This transaction has to be sent from the account that is supposed to be converted.

NOTE: Multisignature Registration Transactions from multisignature accounts are *invalid*.

The following parameters are required to send a Register Multisignature transaction:

. `numberOfSignatures`: The number of private keys that must sign a transaction.
. `mandatoryKeys`: An array of public keys in lexicographical order.
Once the account is registered as a multi-signature account, every outgoing transaction requires a signature for every public key in `mandatoryKeys`.
. `optionalKeys`: An array of public keys in lexicographical order.
Once the account is registered as a multi-signature account, every outgoing transaction requires some signatures for some public keys in `optionalKeys` (the number of needed signatures depends on the `numberOfSignatures` property and may also be zero).
. `signatures`: An array of signatures, corresponding to the public keys contained in `mandatoryKeys` and `optionalKeys`.
All public keys must have a corresponding signature.
The signatures corresponding to `mandatoryKeys` are appended first, followed by those corresponding to `optionalKeys`, where the order of signatures is the same as the order of public keys in the respective array.

Considering the use case example <<escrow-transactions>> from above, the multi-signature registration parameters would look like this:

. `numberOfSignatures`: 2
. `mandatoryKeys`: []
. `optionalKeys`: [AliceKey, BobKey, ArbiterKey]
. `signatures`: [AliceSignature, BobSignature, ArbiterSignature]

=== Option 1: Lisk Desktop

==== Pick account for becoming multi-signature

Please be aware that the address of the multi-signature account is the same as the one before the multi-signature registration.
Depending on the use case, you might want to turn one of your existing accounts into a multi-signature account, or to create a new account which will be used as multi-signature account.

For a step-by-step guide how to create a new account with Lisk Desktop, please refer to: {url_lisk_learn_create_account}[^]

If you create a new account, don't forget to send over sufficient tokens to send the multi-signature registration.

==== Converting a user account into a multi-signature account

Click on the "Register multisignature account" button in the top left menu::
image:integrate-blockchain/multisig/01-register.png["Register button"]

Define required signatures and group members::
image:integrate-blockchain/multisig/02-add-keys.png["Add public keys",300]

Verify correct parameters::
image:integrate-blockchain/multisig/03-verify.png["Verify parameters", 300]

Sign the transaction::
image:integrate-blockchain/multisig/04-sign.png["Sign",300]

Share the transaction::
image:integrate-blockchain/multisig/05-share.png["Share",300]

.Transaction to be signed by all group members
[,json]
----
{
   "module":"auth",
   "command":"registerMultisignature",
   "nonce":"0",
   "fee":"443000",
   "senderPublicKey":"e57a23f897b13bdeef27439bb9f4e29ac0828018d27d6b39ade342879928b46a",
   "params":{
      "mandatoryKeys":[],
      "optionalKeys":[
         "61d320f822fcc163489499200ae6c99a66296513b1ca1066e49a37a026434ac0",
         "dfbe4e3999138d62047c23f61f222a91b24d9d056db055be24f9ab6d95d7aa78",
         "e57a23f897b13bdeef27439bb9f4e29ac0828018d27d6b39ade342879928b46a"
      ],
      "numberOfSignatures":2,
      "signatures":[
         "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
         "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
         "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
      ]
   },
   "signatures":[],
   "id":""
}
----

NOTE: The `000..0` signatures are placeholder for the pending signatures from the members of the multi-signature group.
They will be replaced automatically with the correct signatures, once the members sign the transaction.

==== Collecting signatures (Lisk Desktop)
How to create and collect the signatures from other members of the multi-sig group.

image:integrate-blockchain/multisig/06-add-json.png["Sign",300]
image:integrate-blockchain/multisig/07-review-params.png["Sign",300]
image:integrate-blockchain/multisig/08-sign.png["Sign",300]
image:integrate-blockchain/multisig/09-share.png["Sign",300]

.After Alice signed the transaction
[%collapsible]
====
[,json]
----
{
   "module":"auth",
   "command":"registerMultisignature",
   "fee":"100000000",
   "nonce":"0",
   "senderPublicKey":"83eac294606806e0f4125203e2d0dac5ef1fc8730d5ec12e77e94f823f2262fa",
   "signatures":[
      "6438632a4ef5a6c0b5eaa915ef9e683335cae68abb74e32acfd5ae848d0d3f7a610bfe8024e1655cb1d5d731d6a5e94bfd2556ea32ff5f8c8e1b990673e6f30f"
   ],
   "params":{
      "numberOfSignatures":2,
      "mandatoryKeys":[

      ],
      "optionalKeys":[
         "61d320f822fcc163489499200ae6c99a66296513b1ca1066e49a37a026434ac0",
         "dfbe4e3999138d62047c23f61f222a91b24d9d056db055be24f9ab6d95d7aa78"
      ],
      "signatures":[
         "4b2103fdead3a957e26431e68fe1bf04d4d2ab5aa61c90d0646d33b994de595398be216185c0e92b99384f44cfe17c29186ad75c2d042bf2724d2961a91b270e",
         "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
      ]
   },
   "id":"5e1cb59e883523df4bb4838a9a1f2caa493374810da9d048f2972481430dc5f5"
}
----
====

.After Bob signed the transaction
[%collapsible]
====
[,json]
----
{
   "module":"auth",
   "command":"registerMultisignature",
   "fee":"100000000",
   "nonce":"0",
   "senderPublicKey":"83eac294606806e0f4125203e2d0dac5ef1fc8730d5ec12e77e94f823f2262fa",
   "signatures":[
      "6438632a4ef5a6c0b5eaa915ef9e683335cae68abb74e32acfd5ae848d0d3f7a610bfe8024e1655cb1d5d731d6a5e94bfd2556ea32ff5f8c8e1b990673e6f30f"
   ],
   "params":{
      "numberOfSignatures":2,
      "mandatoryKeys":[

      ],
      "optionalKeys":[
         "61d320f822fcc163489499200ae6c99a66296513b1ca1066e49a37a026434ac0",
         "dfbe4e3999138d62047c23f61f222a91b24d9d056db055be24f9ab6d95d7aa78"
      ],
      "signatures":[
         "4b2103fdead3a957e26431e68fe1bf04d4d2ab5aa61c90d0646d33b994de595398be216185c0e92b99384f44cfe17c29186ad75c2d042bf2724d2961a91b270e",
         "5c40ae332c2becdc885856b0f6027295d47ed977bea89ea26058223425dffb92d7245bf9377019a7c06d547b05d5729cd04f16a363bb756b80c29cca250e5e03"
      ]
   },
   "id":"5e1cb59e883523df4bb4838a9a1f2caa493374810da9d048f2972481430dc5f5"
}
----
====

.After the arbiter signed the transaction
[%collapsible]
====
[,json]
----

----
====

=== Option 2: Node CLI

==== How to create a new multi-signature account (node CLI)
Create the transaction via the CLI and provide all required parameters:

----
lisk-core transacrion:create auth registerMultisignature 100000000 --json --pretty
----

Provide the required parameters, when prompted for them:

----
? Please enter passphrase:  [hidden]
? Please enter: numberOfSignatures:  2
? Please enter: mandatoryKeys(comma separated values (a,b)):
? Please enter: optionalKeys(comma separated values (a,b)):  61d320f822fcc163489499200ae6c99a66296513b1ca1066e49a37a026434ac0,dfbe4e3999138d62047c23f61f222a91b24d9d056db055be24f9ab6d95d7aa78,6290c8b58de8b71fedb7e3cb9a6ee9426aa3e7ac0141f278526375d46705b546
? Please enter: signatures(comma separated values (a,b)):
----

When prompted for the `signatures`, leave it empty for now -  the signatures will be added gradually, as all members of the multi-signature group need to provide their own signature for the transaction.

After providing all necessary parameters, the transaction is returned:

[,json]
----
{
  "transaction": {
    "module": "auth",
    "command": "registerMultisignature",
    "fee": "100000000",
    "nonce": "8",
    "senderPublicKey": "83eac294606806e0f4125203e2d0dac5ef1fc8730d5ec12e77e94f823f2262fa",
    "signatures": [
      "9a2c36568b3d211d2ad3de77ce528e1fc68d42f81862d421166317f282d5e282699ca78e15f94398ffe638a90a130886c65304e362c83fe00b60402983f80c0a"
    ],
    "params": {
      "numberOfSignatures": 2,
      "mandatoryKeys": [],
      "optionalKeys": [
        "61d320f822fcc163489499200ae6c99a66296513b1ca1066e49a37a026434ac0",
        "dfbe4e3999138d62047c23f61f222a91b24d9d056db055be24f9ab6d95d7aa78",
        "6290c8b58de8b71fedb7e3cb9a6ee9426aa3e7ac0141f278526375d46705b546"
      ],
      "signatures": []
    },
    "id": "4e559f9b9d9e120d967be7b5bda177aaaef76b8cb7c8ab8d72e522c63dd5de91"
  }
}
----

Now log into Lisk Desktop with your account that is defined as part of the new multi-sig group.

Copy the transaction from above in JSON string format and proceed to sign the transaction object in Lisk Desktop, as explained in <<collecting-signatures-lisk-desktop>>.

=== Option 3: Lisk Elements

==== How to create a new multi-signature account (Lisk Elements)

==== Collecting signatures (Lisk Elements)
How to create and collect the signatures from other members of the multi-sig group.

[,js]
----
const hexAddress = cryptography.address.getAddressFromLisk32Address("lsk55e8u4heymzmxgcrg4dc5xpgd5ckkyv53oxftb","lsk").toString("hex")
//"5aecf827b6894050fc72fa7435849fd2c74a444b"

const multisigRegMsg = {
	"address": hexAddress,
	"nonce": 0,
	"numberOfSignatures": 2,
	"mandatoryKeys": ["61d320f822fcc163489499200ae6c99a66296513b1ca1066e49a37a026434ac0","dfbe4e3999138d62047c23f61f222a91b24d9d056db055be24f9ab6d95d7aa78"],
	"optionalKeys": [],
};

const tag = 'LSK_RMSG_';
const chainID = Buffer.from('02000000');
const data1 = Buffer.from(JSON.stringify(multisigRegMsg));
const privateKey1 = Buffer.from('6f118182dc728cb2da09148d865a904711805dc31973b39a90b79238d019c834dfbe4e3999138d62047c23f61f222a91b24d9d056db055be24f9ab6d95d7aa78',"hex");

cryptography.ed.signDataWithPrivateKey(tag,chainID,data1,privateKey1).toString("hex");
----

== How to create and sign a multi-signature transaction

=== Option 1: Lisk Desktop

=== Option 2: Node CLI
.Preparation
[TIP]
====
The Register Multisignature command, expects the provided keys in the params to be in lexicographical order.

Use the endpoint `auth_sortMultisignatureGroup` to achieve the correct order for the parameters conveniently.

----
lisk-core endpoint:invoke auth_sortMultisignatureGroup '{ "mandatory": [], "optional": [{ "publicKey": "dfbe4e3999138d62047c23f61f222a91b24d9d056db055be24f9ab6d95d7aa78", "signature": "e17d67b24c1f0ab207a194bd1a1781b1c8c3110bcb427cd26f84f3034afc567583e021df575881c396e286198f4a36749055e717eaa56cd3f1fd2f3d7835b70d"},{ "publicKey": "61d320f822fcc163489499200ae6c99a66296513b1ca1066e49a37a026434ac0", "signature": "85ac61c373218cdf5e0e58a22c9b9ae71cfaf1450062d0302166b60a1cdc3b638eb747ba87c43af20d66b8e9d7513fb1d4cd3800a82debd30f0dc41937cef70e" }]}' --pretty
----

This will return the following JSON:

[,json]
----
{
  "mandatoryKeys": [],
  "optionalKeys": [
    "61d320f822fcc163489499200ae6c99a66296513b1ca1066e49a37a026434ac0",
    "dfbe4e3999138d62047c23f61f222a91b24d9d056db055be24f9ab6d95d7aa78"
  ],
  "signatures": [
    "85ac61c373218cdf5e0e58a22c9b9ae71cfaf1450062d0302166b60a1cdc3b638eb747ba87c43af20d66b8e9d7513fb1d4cd3800a82debd30f0dc41937cef70e",
    "e17d67b24c1f0ab207a194bd1a1781b1c8c3110bcb427cd26f84f3034afc567583e021df575881c396e286198f4a36749055e717eaa56cd3f1fd2f3d7835b70d"
  ]
}
----
====

=== Option 3: Lisk Elements
