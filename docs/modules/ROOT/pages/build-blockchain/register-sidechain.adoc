= How to register a sidechain
Chris Braithwaite <christopher.braithwaite@lightcurve.io> Mona Bärenfänger <mona@lightcurve.io>
:description: How to register a sidechain to the mainchain and vice versa.
// Settings
:toc: preamble
:idprefix:
:idseparator: -
:docs_sdk: v6@lisk-sdk::
// URLs
:url_lisk_wallet: https://lisk.com/wallet
:url_bls_key: https://github.com/LiskHQ/lips/blob/main/proposals/lip-0038.md#public-key-registration-and-proof-of-possession
:url_lip56: https://github.com/LiskHQ/lips/blob/main/proposals/lip-0056.md
:url_lip56_bftweight: {url_lip56}#terminology
:url_update_cross_chain_lip53: https://github.com/LiskHQ/lips/blob/main/proposals/lip-0053.md#outboxrootwitness
:url_exmaples_guides_createparams: https://github.com/LiskHQ/lisk-sdk-examples/blob/292-chain-registration/guides/chain-registration/mainchain/paramsCreation.ts
:url_exmaples_guides_validatorsignatures: https://github.com/LiskHQ/lisk-sdk-examples/blob/292-chain-registration/guides/chain-registration/mainchain/validatorSignatures.ts
:url_exmaples_guides_mcregistration: https://github.com/LiskHQ/lisk-sdk-examples/blob/292-chain-registration/guides/chain-registration/mainchain/mainchainRegistration.ts
// Project URLs
:url_understand_interop_chainid: understand-blockchain/interoperability/index.adoc#chain-identifiers
:url_ccm: understand-blockchain/interoperability/communication.adoc#sending-cross-chain-transactions-to-generate-ccms
:url_ccu: understand-blockchain/interoperability/communication.adoc#creating-and-posting-ccus
:url_sidechain_reg_recovery: understand-blockchain/interoperability/sidechain-registration-and-recovery.adoc
:url_sidechain_chain_store: {url_sidechain_reg_recovery}#chain-substore
:url_sidechain_channel_store: {url_sidechain_reg_recovery}#channel-substore
:url_sidechain_chain_validators_store: {url_sidechain_reg_recovery}#chain-validators-substore
:url_sidechain_reg_command: {url_sidechain_reg_recovery}#register-sidechain-command
:url_mainchain_reg: {url_sidechain_reg_recovery}#register-mainchain-command
// Footnotes
:fn_lip53: footnote:witness[Due to the increasing size of the {url_update_cross_chain_lip53}[outboxRootWitness^] property of the command.]

====
On this page, you'll learn how to:

* [x] Register a sidechain on the mainchain
* [x] Register the mainchain on a sidechain
====

== Registration overview

To complete the sidechain registration process, perform the following steps:

. <<how-to-register-a-sidechain-on-the-mainchain,Sidechain registration on the mainchain>>
. <<how-to-register-the-mainchain-on-the-sidechain,Mainchain registration on the sidechain>>

TIP: Please read xref:{url_sidechain_reg_recovery}[] to get more information about the lifecycle of a sidechain.

:sectnums:
== How to register a sidechain on the mainchain

A sidechain is registered on the mainchain by posting a xref:{url_sidechain_reg_command}[Register Sidechain transaction].

A Register Sidechain transaction *can be sent by any user account* in the Lisk Mainchain that has adequate funds to pay the required <<sidechain-registration-fee,fee>>.

To create a *Register Sidechain* transaction, the following information is required:

. <<chainid>>
. <<name>>
. <<sidechaincertificatethreshold>>
. <<sidechainvalidators>>

=== Sidechain registration fee
When the "Register Sidechain" command is processed, it creates a sidechain account in the mainchain state which is associated with a unique chain identifier and a name.
Hence, every new sidechain occupies a certain namespace within the ecosystem.
Additionally, every newly registered sidechain can increase the size of every cross-chain update command posted on the mainchain.

For these two reasons, the minimum fee for this command has an added constant similar to the extra fee in a Register Validator transaction.

NOTE: The extra registration fee for a sidechain registration is *10 LSK* tokens.

=== Prepare the required parameters

==== chainID
The xref:{url_understand_interop_chainid}[chainID] of the sidechain.
Has to be *unique* within the Lisk ecosystem.

[CAUTION]
====
If the given value is already taken by another sidechain, the "Register Sidechain" transaction fails.

In this case, the sidechain has to change the chain ID with a hardfork, and resubmit the "Register Sidechain" transaction with a new value for the chain ID.
====

// call RPC to check if chain id available for the registered and it should return false
// `interoperability_isChainIDAvailable` with params "params": { "chainID": "04000001" } return false

.sidechain_reg_params.json
[source,json]
----
{
  "chainID": "00000001"
}
----

==== Name
The name of the sidechain as a string.
Has to be *unique* within the Lisk ecosystem  and contain only characters from the set `[a-z0-9!@$&_.]`.

.sidechain_reg_params.json
[source,json]
----
{
  "chainID": "00000001",
  "name": "sidechain1"
}
----

==== sidechainValidators
Defines the set of sidechain validators expected to sign the first certificate from the sidechain.
Each item contains the following properties:

. `blsKey`: The {url_bls_key}[public BLS key] of the validator.
. `bftWeight`: The {url_lip56}[BFT weight^] is the weight attributed to the pre-votes and pre-commits cast by a validator, and therefore determines to what extent the validator contributes to finalizing blocks.

To retrieve the BFT parameters of all sidechain validators, invoke the `consensus_getBFTParameters` endpoint on the *sidechain node*.

Set the `height` to the *latest block height on the sidechain* in the request parameters:

[tabs]
=====
Sidechain node CLI::
+
--
[source,bash]
----
./bin/run  endpoint:invoke consensus_getBFTParameters '{"height": 200}'
----
--
cURL::
+
--
[source,bash]
----
curl --location --request POST 'http://localhost:7887/rpc' \
--header 'Content-Type: application/json' \
--data-raw '{
    "jsonrpc": "2.0",
    "id": "1",
    "method": "consensus_getBFTParameters",
    "params": {
         "height": 200
    }
}'
----
--
=====

This will return a complete list of all active sidechain validators at the specified block height.

Now, paste the *complete list* that was returned by the `consensus_getBFTParameters` endpoint under the `"sidechainValidators"` key:

.registerSidechain.json
[source,json]
----
{
  "chainID": "00000001",
  "name": "sidechain1",
  "sidechainValidators": [
	{
	  "blsKey": "92f020ce5e37befb86493a82686b0eedddb264350b0873cf1eeaa1fefe39d938f05f272452c1ef5e6ceb4d9b23687e31",
	  "bftWeight": "1"
	},
   // ...
  ]
}
----

NOTE: The length of the `sidechainValidators` is equal to the amount of active validators on the sidechain (101 by default).

===== Aggregated BFT weight
//TODO: Clarify what kind of weight we are talking about in this context (could be confused with validator weight)
//TODO: Add link to corresponding LIP
The {url_lip56_bftweight}[aggregated BFT weight^] is the sum of BFT weights of all active validators at a specific block height.

It is used to calculate the minimum and maximum values of :

* the <<sidechaincertificatethreshold>> and
* the <<mainchaincertificatethreshold>>

Minimum threshold:

 min = floor( 1/3 * Aggregated BFT weight ) + 1

Maximum threshold:

 max = Aggregated BFT weight

==== sidechainCertificateThreshold

An integer defining the minimum BFT weight threshold required for the first sidechain certificate to be valid.

Minimum and maximum values for the certificate threshold are calculated with the <<aggregated-bft-weight>>.

.Calculating the aggregated BFT weight for sidechain validators
[source,js]
----
const { apiClient } = require('@liskhq/lisk-client');

(async () => {
	// Update the path to point to your sidechain app data folder
	const sidechainClient = await apiClient.createIPCClient('~/.lisk/hello_client');
	const sidechainNodeInfo = await sidechainClient.invoke('system_getNodeInfo');
	// Get active validators from sidechain
	const bftParams = await sidechainClient.invoke('consensus_getBFTParameters', { height: sidechainNodeInfo.height });

	// Calculate the aggregated BFT weight
	let aggregateBFTWeight = BigInt(0);
	for (const validator of bftParams.validators) {
		aggregateBFTWeight += BigInt(validator.bftWeight);
	}

	console.log("certificateThreshold:");
	console.log("min:");
	console.log(aggregateBFTWeight/BigInt(3) + BigInt(1));
	console.log("max:");
	console.log(aggregateBFTWeight);
	process.exit(0);
})();
----

For this example, the minimum value is 34, and the maximum 101.

Taking this into account, we decide for a `sidechainCertificateThreshold` of 65:

.sidechain_reg_params.json
[source,json]
----
{
  "chainID": "00000001",
  "name": "sidechain1",
  "sidechainValidators": [
	{
	  "blsKey": "92f020ce5e37befb86493a82686b0eedddb264350b0873cf1eeaa1fefe39d938f05f272452c1ef5e6ceb4d9b23687e31",
	  "bftWeight": "1"
	},
    // ...
  ],
  "sidechainCertificateThreshold": "65"
}
----

The transaction parameters are now prepared in `registerSidechain.json` and we can proceed to create and post the transaction in the next section.

=== Post the transaction on the mainchain

Send the `registerSidechain` transaction to a node that is connected to the mainchain.

NOTE: The Lisk Core node CLI is used in this example to post the transaction.
Alternatively, users can use the {url_lisk_wallet}[Lisk Wallet^], where the transaction can be created conveniently as well.

[source,bash]
----
lisk-core transaction:create interoperability registerSidechain 2000000000 --pretty -f ./registerSidechain.json
----

The transaction will be returned in hex format:

[source,json]
----
{
  "transaction": "0a10696e7465726f7065726162696c6974791211726567697374657253696465636861696e18012080a8d6b9072a203972849f2ab66376a68671c10a00e8b8b67d880434cc65b04c6ed886dfa91c2c32e32a0a0403000008120b73696465636861696e2d381a340a308dffebf58c3ffeada90d1196d2587d4e8342a4caf7283351e12403d543cd7452b24f4a6d359b160c439dbbed11d7a8fe10011a340a3095ce3d5fb56fb8540f57f626b65fea8ea9a2792371854ffa011a2e99d8ca70abec0ef3a5bef57ad593e20466c9a2b1fa10011a340a308c9abeecbf578e6f6f50eb2c1148f80ec4058c51d7e442b899a6c7f9ec89db3bc20ed95488f2817c0e5ab64f8332cef610011a340a3080e1925e87e8435be1459e6e03f4aea41280e352ff0d30a356d31e9669587bb30de8cfc095fba2c4dcea145edaac3d9f10011a340a30aaafcac8e9fa128140a063a6b8ebe3db77df53b04bcc80c4998c27434b98cc9f8b2fc48a7e499209d4f986035b56f7bb10011a340a30b2f7593bf4b73356c758542f305518056d618415e96ffdf1f5ae4aab2de013d484f062ca2ec7fd6880e7df2345acfc0510011a340a30945f96d83664c47a0b7cd6f64933085e6bf43b382b6ce555c96d6f706c8800a9848605af7b59f7866346390122d8c6a410011a340a30a431b13fb40e7bae6fada4d32e64641704202a8e1f64ec95438d8b49e5cb6cbaece08daea219f43ed5de3162c005748010011a340a30a467fadad40ad44bc5b63abc2e0f43054032475cc8eac21fe93e0aaf6d0822fd390f7464608240f780c7905367aa4ef210011a340a30b7ff6780436377ae340c1081f04e5a4ce2c4459421278ca6198b982b044a8e2bb3143b8a1a7fdb2f4cc2c55020d1948c10011a340a30a3ba48f22c963c5400ee6206097573a333d67acaaae93ec8f3666cafbb6249db69ff0cb1ba13e612fec135ff2f3cc02310011a340a308d2c2ee2b55d7d19d6e42eebc881fcb28cf3b442db0ecd23307d89c3ed2ee25864a0f97fecdeca17a30c01648343d37610011a340a30afc6af040b6234b5d928c0c4fcd8bfa6715e6f779e26acc19b79c7be7629b0bb00cd39fb3ffee64fab1e8174ac1d959410011a340a3083a2728e7209144ce73eccf5bad1dd47ce48291c04c9970094bbdd7c6693a141daa39f98474a4c57c2515eb6ca5dc88210011a340a30ab58a1900ff71771aca333163ff0fa9f1112986347f6ec8e31c455978c6adb256af8313ce719d3da5e3c7c27d34267a210011a340a30881e474dbbaa65962491eeb3b747954658550c4fdb30246336db2bce83851d33b15f6cf44f25cd9deff484fc88c9ea8010011a340a3089df859598134753ad8adb525c36979ca5b17ec7bd37ef6ed7461fcb0680c336bffb159f6cdc06b6d78d73cf24c1f54910011a340a30978707c5713808cb16d048fa7b27545b14a2cd99d16adbdd4b141c92ff8658c71a5c66051450554c2a5bbf0cfbd34c3f10011a340a30b66bc3797dceb6567c8aea87a3887f12fe85fe9af8df19a5e66a1eb730d8f8288bca6f1bf24970dd2ad047df5376e3e010011a340a30b8b0050f1662a6b12fe95f632368ad963001c51ce04aac76aae21a51c1199551bfe1d7abe8a21de7364a132233d52eca10011a340a308da4a9262ec1f0d01640b94bec00ac51594cfaff14ea3b9b2f79773dc1c3ca63eb7d86da2570b88efa1fe33425a287b310011a340a30a11ee270162c55cb7985d4247985a33c7102aa4e637018e03119887c6e73910e8cef8ceb23d76e5dc4f73679b3f1e42110011a340a30b601f03ca5ebb416d82c070be4cd8232df28f37d92549d4d6381b082fb9b80a8777e44d324728f957a934a454e0cfb1510011a340a308f4e15c9a87132453e669b7dd6f10616a58b45f3eacae0e31dbe7bea232066db881ae00907234f230fca932d5986d3e010011a340a3083717971cbe501ea79594c5ceae80fe3c09d1990faffafa2ae273908f9c99d2b27f245a4e3b03e51e18e0b1a54b237e410011a340a30887d62bd098d331d647c57f52427eb1c991ac76a60881eba96c312a904014d8c261f42854f6a841951307959f8c2e41010011a340a308012798d2ac6b93df3bfa931192d9b2d496c3c947958a7408232e08872895557c06c1b94f5cc2555e28addbaadf3e0bd10011a340a30b3df1d6c635e97b7b2e9feb00870c6238b7bda7246d6849b1fd549616aba816f1a265c7eeed15a4c35655c2fee62e65710011a340a30b5d203c4555d4c7b3329ae1bd725a0a909a60322c7bbdc7a8630169ef7b1e8e3599fbac6336b1841b54b6bde9fef6b5a10011a340a30997efce2f5b5b0efc97b3d0c689813fb56e3ed0627fe6b88cee495466ebd604500a13cf7ed8808a63fbd915cc8a9c36610011a340a3092a25b59d8a5ff6484d45516a07080f890883d761562d7c177d747e9148ba92092c96f373348e65e0c89cca0c837efa710011a340a30b93b3f3ca115695b018229db563bfa024cdee752ef7e710b3818d4234dace5fd67e345fcb90f21198ebefe6c2d87d28d10011a340a30820f7ee17502c75c80b3830fa2912f174e7f0972414fba035973bba4cb873e9f21d594575f8db2255d58e69c136f90ce10011a340a30b49ec00ad81c92bc1137ba5ac09d41bdb3d7cba1679ccf793e5ca5991d8215bb32462c7af55c386ea8482181f72b165e10011a340a30afed4083c5523f6c76d82a00598673fc8fc33a89ed6d94a473cea54c044a0f0a77ae58e90ad808df9e23286d37a818f810011a340a308ff19b8a449c0b2c716e3041f58484e2e1f5ab7ba279fce30ddac50fb4ac14d146fe4ed57ac9581004b8cd4134256a0c10011a340a3096fbcdcc73487b93642d848007f4c5803f3aa6073789611071ec22ae28fa4d68e7480574023b4e8ab1e2026ae6d1bd5610011a340a3097ab2fbbd6302314ee1bb350156111d621268c4715c7e2fc17bca5fc8d4ac067f250d1ea383e6e12c4322d3d09d4786710011a340a30859c2f41d5c95638469796b4bed1f788b3a4da2aa3730953d96cd06fc0bdd1942213644f5415059710394b5c21970b2910011a340a30877342d9da45cdb72cea1b3f83ff391a25bbb40f0f17005aceb39a6102ea8ced78021bd830f378edd8a815b6c3f1628010011a340a30b3fea6464eb53f32f02dc3b6c313ba617466decf7f8bdc76a7cd5b1fbed45c85324654e131b0a54ec18c30c90ca1fc4610011a340a30a631f867d8196d249221ade60de85b2fdd2c420b253655c4db8129358ff9f1465b8bdefedc43b065328ac577102d838910011a340a308fd987c26195f8a16e8887c4da08e98a6ce2fcf566cc9aeb10a591b8cfc8b2dd63e352f7f89a34de508defc6fa74a38910011a340a30998cae9553f1b857679fea5483f62f7df90c6069067839444eca468427d5475ae8c30981fee9efce0d7ea051a9f8057b10011a340a3093b377e225e453e945772185dfcd804ffea9f15bf24db21945336f55b9bf477605116aec69321fbcb1ccfc42b6c7b7f510011a340a30acac37c80386a65aec329e2554a7603e1a225d4e2d66c338222b5c047b95f4f730717db707625ed95ec5e89f43e3931710011a340a30a68c525a3f41a5bfaf2da2d2c50868bd1cfa2dfa8b202692bc6f526f91fc783b400754ca1b20b8b02b61c740a828c66710011a340a30b07d6418604357a7d1c9d388175eb702ee17411db1cc0939015a9b4ba104addeaee14ab3e616a10444c72a94be518b2810011a340a308d23cdf74166e64a3163f3219ac4b7b233e34a455a789fad2faaf522523cfe75c4f817575ddbfd24710b3b2cdff08ebe10011a340a30a51c34b3b8a21df3aa05be07467c9b4d3d90dbcc7791c747c2f0f30d2ac871aaac3199716bf3e7248f25d3e9045d055210011a340a30af5b2dcb3ea14e0820d3d8b2b0d21594be9b8acfaf2cb77148cf3fe8e9900334ae60d0311278673e50753e5a3ff62bfa10011a340a3093ca96d5240a440cd0c51bee1ad76d3d9bf5d80208b8dc7af8f2acfb6183b8e600232b683ce8da402f52139b84c9946110011a340a3093111acc2098a914e9377be0c044695c37a3e3d69d1ccd2400eab59b0e846f27fd3a084ff3cff5b4de01890c4083921e10011a340a30873096d7b1d2cdf69d2a4b492b5d9d1ae0baf1c8cdde3b096a83a08e696bb9c4a18cafac212741064703dec95efd29e610011a340a30829ce5aaea989ae0fbe8afb2211f2630b7df1035a69462ca2b9c6d4aeef48d3232528ffb5ccb4ae01396a4654f1fbb4110011a340a308fe15645e54ffb3a815bc93f882986b42655e0b20cf112f71ed94b331b714d50c1a44d9c28b9bcd140741adec159c8ce10011a340a30a0465875b9eaba9270d4b288e3271f388174f8756b153537e32f8a1abd1e3df7e63029f59dff882859bac585e21a2bfc10011a340a3085ad6e9a5650864d4a332bace72a497e5df917362b4de8246095c985b571e13fa6f344e5d265f28cbf255f57edefb70410011a340a3089e65c4fec65d41861135cc1304ac2c5bf6da9099aa9c161b24cf68fc8fbc5835d54c62de475c6545676f252ba9bfc1610011a340a30ae8aa2862a9efa27515885f810be2ae2ebe8a681289a348b28a6f6f65d067bcc5bdaf82b2f7a26c8c3e6025cec257a0e10011a340a30a6b88f31d6ddcb1e195d166253f5629c2cf03430d946a9807b7c1b413b60186cf6588aad67a453c6d37a5c97a10f284510011a340a30862b40bafbe512e98c62ed88bef47531f180b60584163e550a7a94574f7cc5df2d768bc1eded57aa5d011b5c7ca1a0e910011a340a309070783523bcdd8d0ed5fdc7eb0d40d22d0dde03be06e1a6beb541efbb4b764dba27ad4c6fd7b0f3802abab7c4bf48fc10011a340a3090d95277900969ff5ebd7f92edebaa16e0af77a1622b36f76d8f93b790461529886fe7b132de3b31c82bf35f05274c0a10011a340a3091412ac7e9faa84f4d23dc821212b8eadee0094a29985776be57681373314561a53a6e7112d6b7e66076242752db885f10011a340a30b0638b4ecfd3413156c292b242a0c3378807f9346649498cb3fa4adc8926630df487c89033de5275ec400be830c569b110011a340a30b840b34a50c5dc3aa7c5d48e0fd803554eb6125e22c78f81e122ed6c418c069a98cf2c0f8c6e701ba8ef5c68eb4f6d9910011a340a3081b45d2107aa0eb61951d7cd4e19a7eb67135d790e6de0b17e31b8089a0efa52ae5b9e0a51da75692344a7e15008fc7710011a340a3095ecca2fe2fecfa5380a4eb2bc1a548fe4a7b9bd6c2d739df7b4b8330943319d0800ccba5dc8f4e797d526ee463dd10310011a340a30a3032a4a9dc05865b5472f04c40be6d22b44c0426657fbdb7140692adc5bd37cf6e016ebe248f503b39b6d21084e41b910011a340a30aacc9c3bce591c6df8c6d51ebedb10230278a6572eec45f2f9e16724860ae191de0a1ee5bff4dbc0a0b20c1b7b21404a10011a340a3083058f8ade0796d972870804d8f18266f5fb528e3c2e5e0f43244c316a95854ee4668962e3564ae35b340234b0778f0d10011a340a30a4eee0606ae9f264e1ff8f503a729dd7bac0ad54d25bffbbe326b433278c96c4ed2f3f72d26b932f6b32af94b5c2749a10011a340a30aabfd06ba90f276e2a8d7b184f3bbcd8d4e74e0fe9e6705939245473b61594e33c887434848d0e5397e62e9150aedfff10011a340a30acb45a0005a60941da882ed2da269409eb34c644867d739ad6b5732b88a6a6a43c05e0b139bba4d92888785de1fa3f9710011a340a30b15c96b9021b9a44d0695889a86223e1bff2c7b7f394c41f4f44551778f7e9a74b6eff75a620e4236b310025c23b59b910011a340a30a8770bd80506a25e6e3a1bb2cffaa978b76a0f4b197250e99b1562dc4a24ec84365836a564b6015e1f5017c2c2be40b310011a340a30a969902eeefec56d45f5e4ee5b39a36ed6d9f2c29e895fe231ae30eb6e4ec240321099d55ca04ad956a47c957d19551910011a340a3099b0fe1e7663e88ac6ce674e998575d6f2dd543c0e3df2eb232683e432d6debfe659cb81147db1881da073d5274da6bf10011a340a30b27e76e5c7714dca4b29e06ca8886ef48d2905b64bb433d6d91f8f9820d962edc623597f093ad95f251eda9daf44366e10011a340a3090e260d227910c87325dac2af90bd1dab75b35877c6394c3dd998c69968a8906484d8b79e31ddf589c5f0273702fa2cc10011a340a30915d3e77d79e71701a381182858ba7c093dddd8520cc4100b36183bd5b7acfe7aa5fdf5fb8911d725ae3cf6649ceee1910011a340a30afe6f88cd931ab9380f2c6b635c0902cb26a62c9bef1fa2af385c13ed74460a5b43ef14302c602f3ce99c991ca1a3e3710011a340a30aae56df01d3622c28ca9b5eda7daf89f20b582c9717c69ab36cc6349bdc9eb472d170e85b43abda4294903dcc92ea73110011a340a308ef2e03d79edcbaeb08c528bb0c9935514c519837b33617489c53ba6cc779518593d74d7517d479c45fbb0f40f9d14af10011a340a30a05971bcbd5c7664483b733f3abcb8113a54e172028e82ee150245358e7f6e28e3ef8671376560e51d19de152796d43b10011a340a3092671742234400905ce8883f6b943254bd7fb0eef570be7d159806fdd362ce4aa8d4008b7da47fff8211169afe59a11610011a340a30967579545754c9c54aec95b0a239bb30235ca508db1de87e180da53fa34e0dfb1c0e81c79d0151d137533c0aad9bcf5610011a340a308ccfd6da5329870298507954656596a1beb91f092bd71e3482d6aa0f0861c1a22cf98dd3425b22591bef16b55c97282810011a340a30a6a7b82b9498d5bc31211f4d553dee28c4663e581353b1318f1efce688b5e644133ef3d5c7f0f72ccd0428be920dd95c10011a340a3087b8aeac87599f5bff2e3300066c24a8403cebcd1e5fc266a647206183f54c23b9e7c3265479686fd7aeb641a802077710011a340a30ae04d789dafd10de9a5f3bde4a94dd9a7394a05ac02a47c988e231068c3305d826999055df5800549c303aa0fda04f4e10011a340a30ae0ca95ecdf0e239939faa742364f1366aa7783afde967b6c7220c76554630bd67a33895a7cc045201da9950cd44335c10011a340a30a6d989d85a75b1cf9b84fa946cdb36de9416445c984f8e09b535c9c83a9f7b67235af5197dfa76183d95aa1ef324105110011a340a308c1e40bef7a44f1551bfb851d48433287e7a41bb542bb6986e1f48c4b4dc19416a81a65c4e0f6bf2c03b05fc4d10620f10011a340a30aed6d88809fe58319f9f8754526ae4e42afaa66d3266e2ca43f6a1da45373a09a761ca27764985adcdb464c2a9caa3bd10011a340a308700c97a52f04808d97767dcc80246a0a57fa37543c8113a06bfebab16af683071ce215edfb1133d436794f46d59b7af10011a340a3089e722afc26c0aca7bbe0aeda3711f0e853f404fd1c916472a02455ef8449d05122829b45eff4e09d38fa24737da763910011a340a309137374c6ed262c52912bd503a7e3bcbff70fa0c46d61c5bf790aae79fa500a77e9bd98abdc3ddb2a5a13b6c36eec6fa10011a340a30a25cb4cb5c245e4b2286af666653aeaad9f1df9c6dc53fd64ed2973a84af0a4d7fc1acfc9f28402e7d3b9652f867948510011a340a30a0a433d16e1ef74e9c9a9c775c107090413f06b1b4d3a8f83143f61d74792bf677edf837e5d7f65fefbf4c36569fa298100120423a40cd1d0db654582e88fa61ec366b2a32d48b37bab00d0527678f3c5d9d24605dccf756cc16ec8c9ac25ea78137e7b306081c77ae15d2106413cf9a707d618fa108"
}
----

Copy the transaction and send it ot the node, for example by using the node CLI like so:

[source,bash]
----
./bin/run transaction:send 0a10696e7465726f7065726162696c6974791211726567697374657253696465636861696e18002080a8d6b9072a20a3f96c50d0446220ef2f98240898515cbba8155730679ca35326d98dcfb680f0324a0a0404000001120a73696465636861696e311a340a3092f020ce5e37befb86493a82686b0eedddb264350b0873cf1eeaa1fefe39d938f05f272452c1ef5e6ceb4d9b23687e31100220023a408261e374405af4ec1143dfc0ae82a38e385d0edce870f698385749112064b374ac0de67354210aa27280db82121ec0bce195e5630c56a568a8b99dbbcb3a3d0b
----

If the node accepted the transaction, it will respond with the transaction ID.

----
Transaction with id: '1d944f3fb46714978ad7bedd1b788919c3b37e92d893088fd056f8217f20ed8a' received by node.
----

== How to verify the sidechain registration

=== Check the sidechain account
Once the Register Sidechain command is processed, the sidechain account `status` is set to `registered`.

To verify that the account was created successfully, request the `interoperability_getChainAccount` endpoint from a mainchain node.

Parameters:

* `chainID`: The chain ID of the registered sidechain.

[tabs]
=====
Mainchain node CLI::
+
--
[source,bash]
----
lisk-core endpoint:invoke interoperability_getChainAccount '{"chainID": "00000001"}'
----
--
cURL::
+
--
[source,bash]
----
curl --location --request POST 'http://localhost:7887/rpc' \
--header 'Content-Type: application/json' \
--data-raw '{
    "jsonrpc": "2.0",
    "id": "1",
    "method": "interoperability_getChainAccount",
    "params": {
         "chainID": "00000001"
    }
}'

----
--
=====

This will return the respective sidechain account stored in the xref:{url_sidechain_chain_store}[Chain substore] of the mainchain.

.A newly created sidechain account on the mainchain
[source,json]
----
{
    "id": "1",
    "jsonrpc": "2.0",
    "result": {
        "lastCertificate": {
            "height": 0,
            "timestamp": 0,
            "stateRoot": "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855",
            "validatorsHash": "58fa1be3fca7aef9952a7640397124229837079b14a144907a7e3373685daceb"
        },
        "name": "sidechain_8",
        "status": 0
    }
}
----

=== Check the sidechain channel

To verify that the channel to the sidechain was created successfully, request the `interoperability_getChainAccount` endpoint from a mainchain node.

Parameters:

* `chainID`: The chain ID of the registered sidechain.

[tabs]
=====
Mainchain node CLI::
+
--
[source,bash]
----
lisk-core endpoint:invoke interoperability_getChannel '{"chainID": "00000001"}'
----
--
cURL::
+
--
[source,bash]
----
curl --location --request POST 'http://localhost:7887/rpc' \
--header 'Content-Type: application/json' \
--data-raw '{
    "jsonrpc": "2.0",
    "id": "1",
    "method": "interoperability_getChannel",
    "params": {
         "chainID": "00000001"
    }
}'

----
--
=====

This will return the respective sidechain account stored in the xref:{url_sidechain_channel_store}[Channel substore] of the mainchain.

.A newly created sidechain channel on the mainchain
[source,json]
----
{
    "id": "1",
    "jsonrpc": "2.0",
    "result": {
        "messageFeeTokenID": "0300000000000000",
        "outbox": {
            "appendPath": [
                "16dfaad8458dd4ae56ba2787593c2c5a55b14ba734c0431f177212226cf8328b"
            ],
            "root": "16dfaad8458dd4ae56ba2787593c2c5a55b14ba734c0431f177212226cf8328b",
            "size": 1
        },
        "inbox": {
            "appendPath": [],
            "root": "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855",
            "size": 0
        },
        "partnerChainOutboxRoot": "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855"
    }
}
----

=== Check the sidechain validators

To verify that the sidechain validators list was created successfully, request the `interoperability_getChainValidators` endpoint from a mainchain node.

Parameters:

* `chainID`: The chain ID of the registered sidechain.

[tabs]
=====
Mainchain node CLI::
+
--
[source,bash]
----
lisk-core endpoint:invoke interoperability_getChainValidators '{"chainID": "00000001"}'
----
--
cURL::
+
--
[source,bash]
----
curl --location --request POST 'http://localhost:7887/rpc' \
--header 'Content-Type: application/json' \
--data-raw '{
    "jsonrpc": "2.0",
    "id": "1",
    "method": "interoperability_getChainValidators",
    "params": {
         "chainID": "00000001"
    }
}'

----
--
=====

This will return the respective sidechain account stored in the xref:{url_sidechain_chain_validators_store}[Chain Validators substore] of the mainchain.

.A newly created chain validators list on the mainchain
[source,json]
----
{
    "id": "1",
    "jsonrpc": "2.0",
    "result": {
        "activeValidators": [
            {
                "blsKey": "8012798d2ac6b93df3bfa931192d9b2d496c3c947958a7408232e08872895557c06c1b94f5cc2555e28addbaadf3e0bd",
                "bftWeight": "1"
            },
            // ...
        ],
        "certificateThreshold": "66"
    }
}
----

== How to register the mainchain on the sidechain

The mainchain is registered on a sidechain by posting a xref:{url_mainchain_reg}[Register Mainchain transaction].
A "Register Mainchain" transaction can be sent by any user account in the sidechain that has adequate funds to pay the required fee.

[IMPORTANT]
====
* The mainchain registration process always has to occur *after* the sidechain registration on the mainchain, since the sidechain has no prior knowledge of its name and must be certain that the correct chain ID has been registered.
* Connections to both mainchain and sidechain node APIs are required to create a Register Mainchain transaction.
====

[CAUTION]
====
* It is of key importance that the sidechain validators ensure that they are signing the registration command with the correct information, otherwise the sidechain interoperable functionality may be unusable.
====

To create a *Register Mainchain* transaction, the following information is required:

. <<preparing-the-register-mainchain-parameters,Mainchain registration parameters>>
.. <<ownchainid>>
.. <<ownname>>
.. <<mainchainvalidators>>
.. <<mainchaincertificatethreshold>>
. <<preparing-the-aggregated-signature,The aggregated signature of the sidechain validators>>

=== Preparing the Register Mainchain parameters

The Register Mainchain parameters are created in an analog way as the Register Sidechain parameters have been created in the previous step.

[TIP]
====
To conveniently prepare the required parameters, check out the following script in the lisk-sdk-examples repository:
{url_exmaples_guides_createparams}[paramsCreation.ts^]

Executing the script after installation of the dependencies should create a new file `params.json` with the following parameters:

. <<ownchainid>>
. <<ownname>>
. <<mainchainvalidators>>
. <<mainchaincertificatethreshold>>

Open the file `params.json`, to verify all values were generated correctly.
The next step is to collect and aggregate the corresponding signatures form the sidechain validators, see <<preparing-the-aggregated-signature>>.
====

==== ownChainID
The chain ID of the sidechain.

Should be identical to <<chainid>>.

==== ownName
Sets the name of the sidechain in its own state according to the name given in the mainchain.

Should be identical to <<name>>.

==== mainchainValidators
Defines the set of mainchain validators expected to sign the first certificate from the mainchain.
Each item contains the following properties:

. `blsKey`: The {url_bls_key}[public BLS key] of the validator.
. `bftWeight`: The {url_lip56}[BFT weight^] of the validator.

////
To retrieve the BFT parameters of all mainchain validators, invoke the `consensus_getBFTParameters` endpoint on the *mainchain node*.

Set the `height` to the *latest block height on the mainchain* in the request parameters:



[tabs]
=====
Lisk Core CLI::
+
--
If you maintain an own instance of a Lisk mainnet node, it is possible to invoke endpoints directly via the node CLI:

[source,bash]
----
lisk-core endpoint:invoke consensus_getBFTParameters '{"height": 200}'
----
--
cURL::
+
--
Replace `localhost:7887` with the IP and port to a node that is connected to the Lisk Mainnet.

[source,bash]
----
curl --location --request POST 'http://localhost:7887/rpc' \
--header 'Content-Type: application/json' \
--data-raw '{
    "jsonrpc": "2.0",
    "id": "1",
    "method": "consensus_getBFTParameters",
    "params": {
         "height": 200
    }
}'
----
--
=====



This will return a complete list of all active mainchain validators at the specified block height.

Paste the *complete list* that was returned by the `consensus_getBFTParameters` endpoint under the `"mainchainValidators"` key:

.registerMainchain.json
[source,json]
----
{
  "ownChainID": "00000001",
  "ownName": "sidechain1",
  "mainchainValidators": [
	{
	  "blsKey": "92f020ce5e37befb86493a82686b0eedddb264350b0873cf1eeaa1fefe39d938f05f272452c1ef5e6ceb4d9b23687e31",
	  "bftWeight": "1"
	},
    // ...
  ]
}
----
////
==== mainchainCertificateThreshold
An integer defining the minimum BFT weight threshold required for the first mainchain certificate to be valid.

Minimum and maximum values for the certificate threshold are calculated with the <<aggregated-bft-weight>>.


////
In this example, we decide for a `mainchainCertificateThreshold` of 55:

.registerMainchain.json
[source,json]
----
{
  "ownChainID": "00000001",
  "ownName": "sidechain1",
  "mainchainValidators": [
	{
	  "blsKey": "92f020ce5e37befb86493a82686b0eedddb264350b0873cf1eeaa1fefe39d938f05f272452c1ef5e6ceb4d9b23687e31",
	  "bftWeight": "1"
	},
    // ...
  ],
  "mainchainCertificateThreshold": "55"
}
----
////


=== Preparing the aggregated signature
To create a valid signature, an amount of sidechain validators equal or greater to the <<sidechaincertificatethreshold>> need to individually sign the Mainchain registration with their account.
All individual signatures are then aggregated into one signature which is appended to the Register Mainchain parameters.

The individual signing of the mainchain registration by the sidechain validators is executed *off-chain*, similar to the process of creating multi-signature transactions.

==== Collecting the signatures of the sidechain validators

The process of signing the registration parameters needs to be coordinated off-chain by the sidechain validators.

To simplify the process, you may use the following script, which adds a validator signature to an existing list of signatures: {url_exmaples_guides_validatorsignatures}[validatorSignatures.ts]

The script expects the following files to be present:

. `params.json`, which was created in step <<preparing-the-register-mainchain-parameters>>.
. `keys.json`: a file with the bls keys of the validator intending to sign
. `sidechainValidatorSignatures.json`: List of already existing validator signatures.
If no such file is found, it will be created newly.

After installing the required dependencies, the script can be executed like so:

[source,bash]
----
node validatorSignatures.ts
----

As a result, it will append a new signature to the signatures listed in the file `sidechainValidatorSignatures.json`.

Once the aggregated BFT weight of the validators who signed is equal or above the <<sidechaincertificatethreshold>>, enough validators have signed the registration parameters.

==== Aggregating the validator signatures

Once enough validators added their signatures, the list of signatures is aggregated into one single signature, which is then appended to the registration params that we created in step <<preparing-the-register-mainchain-parameters>>.

The following script is performing the required steps: {url_exmaples_guides_mcregistration}[mainchainRegistration.ts]

The script expects the following files to be present:

. `params.json`, which was created in step <<preparing-the-register-mainchain-parameters>>.
. `sidechainValidatorSignatures.json`: List of validator signatures.

After installing the required dependencies, the script can be executed like so:

[source,bash]
----
node mainchainRegistration.ts
----

As a result, it will create a new file `mainchain_reg_params.json`, including all required parameters and the aggregated signatures of the sidechain validators, which is verifying the correctness of the parameters.

signature::
The `signature` property is an aggregate signature of the sidechain validators.
It ensures that the sidechain validators agree on registering the mainchain in the sidechain.

aggregationBits::
The `aggregationBits` property is a bit vector used to validate the aggregate signature.

The file `mainchain_reg_params.json` can now be passed as parameter source, when creating the `registerMainchain` transaction in the next step.

=== Posting a Register Mainchain transaction

Send the `registerSidechain` transaction to a node that is connected to the mainchain.

[source,bash]
----
./bin/run transaction:create interoperability registerMainchain 2000000000 --pretty -f ./mainchain_reg_params.json
----

The transaction will be returned in hex format.

Copy the transaction and send it ot the node, for example by using the node CLI like so:

[source,bash]
----
./bin/run transaction:send 0a10696e7465726f7065726162696c6974791211726567697374657253696465636861696e18002080a8d6b9072a20a3f96c50d0446220ef2f98240898515cbba8155730679ca35326d98dcfb680f0324a0a0404000001120a73696465636861696e311a340a3092f020ce5e37befb86493a82686b0eedddb264350b0873cf1eeaa1fefe39d938f05f272452c1ef5e6ceb4d9b23687e31100220023a408261e374405af4ec1143dfc0ae82a38e385d0edce870f698385749112064b374ac0de67354210aa27280db82121ec0bce195e5630c56a568a8b99dbbcb3a3d0b
----

If the node accepted the transaction, it will respond with the transaction ID.

----
Transaction with id: '1d944f3fb46714978ad7bedd1b788919c3b37e92d893088fd056f8217f20ed8a' received by node.
----

== How to verify the mainchain registration
=== Check the mainchain account
Once the "Register Mainchain" command is processed, the mainchain account is initialized and its `status` is set to `registered`.

To verify that the account was created successfully, request the `interoperability_getChainAccount` endpoint from a sidechain node.

Parameters:

* `chainID`: The chain ID of the registered mainchain.


[tabs]
=====
Node CLI::
+
--
If you maintain an own instance of a sidechain node, it is possible to invoke endpoints directly via the node CLI:

[source,bash]
----
./bin/run endpoint:invoke interoperability_getChainAccount '{"chainID": "00000000"}'
----
--
cURL::
+
--
Replace `localhost:7887` with the IP and port to a node that is connected to the sidechain.

[source,bash]
----
curl --location --request POST 'http://localhost:7887/rpc' \
--header 'Content-Type: application/json' \
--data-raw '{
    "jsonrpc": "2.0",
    "id": "1",
    "method": "interoperability_getChainAccount",
    "params": {
         "chainID": "00000000"
    }
}'
----
--
=====

This will return the mainchain account stored in the xref:{url_sidechain_chain_store}[Chain substore] of the sidechain.

//TODO: Add example output

////
=== Check the mainchain channel

=== Check the mainchain validators////

