= Network
Mona Bärenfänger <mona@lightcurve.io>
//Settings
:toc: preamble
:idprefix:
:idseparator: -
// URLs
:url_github_lip_4: https://github.com/LiskHQ/lips/blob/master/proposals/lip-0004.md
:url_wikipedia_rpc: https://en.wikipedia.org/wiki/Remote_procedure_call
:url_wikipedia_websocket: https://en.wikipedia.org/wiki/WebSocket
:url_socketcluster: https://socketcluster.io/#!/
//Project URLs
:url_tx_pool: understand-blockchain/index.adoc#transaction-pool
:url_blocks: understand-blockchain/blocks-txs.adoc
:url_transactions_id: {url_blocks}#transactions

Connections in the {url_github_lip_4}[*Lisk P2P protocol*^] are established as _WebSockets_ (see {url_wikipedia_websocket}[Wikipedia page]) using the {url_socketcluster}[_SocketCluster_] framework.

The Lisk P2P network protocol has the following characteristics:

== Unstructured P2P network

image:understand-blockchain/unstructured.jpeg[,400,role=right]

Every node in the network only connects to a subset of other nodes in the network.

Lisk nodes connect to each other in a random manner, thereby forming an *unstructured P2P network*.

Unstructured P2P networks scale quite well, which makes the P2P layer ready to handle a large number of peers.
At the same time, they are more robust than structured networks, and provide a higher security against network attacks.
//while maintaining a robust gossip-based protocol.

== Eager and Lazy Push mechanism

.P2P connections of a node
image:understand-blockchain/p2p-network.jpeg["Node Connections",400,role=right]

Lisk uses a hybrid of eager and lazy push mechanism:
A node uses eager push for a small number of the connected peers and lazy push for the majority of the connected peers.
This means that a complete block is sent to a small number of connected peers and the block hash to all other connected peers.

Each node retains a list of known peers and their IP addresses and initializes up to 20 outgoing connections to randomly selected peers, while accepting up to 100 incoming connections.

When an outgoing connection is dropped, the node starts a new connection with another peer.
Furthermore, to keep the network dynamic, approximately every 5 minutes one outgoing connection is dropped and replaced with a new one.

NOTE: Both, incoming and outgoing connections are *bidirectional*, meaning, information can be exchanged in both ways.
Incoming and outgoing only refers to the node who initiated the connection first: "Outgoing" means, the node initiated the connection, "Incoming" means, a peer node initiated the connection.

== Peer discovery

. Every node first connects to the seed node, defined in the nodes config.
. Every peer makes 20 outgoing connections to randomly chosen peers from its list of known peers.
. If an outgoing connection is closed by the other peer, a different peer is randomly selected as a replacement.
. Every peer accepts up to 100 incoming connections from other peers, which are distinct from the outgoing peers.
. Periodic shuffling: Shuffles the peer list of nodes randomly in a certain period.
Every time an outgoing connection is terminated, a new outgoing connection is established.
This makes the network more dynamic and prevents against network attacks.


== Block propagation
//TODO: add link once consensus explanations are created
//Nodes propagate newly received blocks in order to keep the network synchronized and to achieve xref:{url_consensus}[consensus].
Nodes propagate newly received blocks in order to keep the network synchronized and to achieve *consensus*.

When a new block is received, it is first validated.
If it is valid and has not been received it is forwarded.
The block is forwarded to 16 randomly chosen connected peers of which at least 8 blocks are forwarded via outgoing connections.

image::understand-blockchain/block-propagation.png[]

Furthermore, nodes announce that a new block has been received by sending part of the block header to the rest of the connected peers, which can request the full block in case it has not been received yet.

The peers are notified about the block after the block and its related state changes were executed successfully on the node.

image:understand-blockchain/block-processing.png[]

== Transaction propagation

Transactions are propagated through the network in a similar manner to blocks.

Every 5 seconds, up to 25 xref:{url_transactions_id}[transactions] are selected from the transaction pool and sent to all connected peers.

The peers then check if they already have the corresponding transactions and can request any that are missing from the node and include them in their transaction pool.

=== Transaction pool

The xref:{url_tx_pool}[transaction pool] collects transactions that are waiting to be included in a block.

While generating a new block, the validator selects a set of transactions from the pool and includes them in the xref:{url_blocks}[block].

Conversely, when a new block is received, transactions included in the block are removed from the transaction pool.
